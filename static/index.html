<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitAI - ヘルスケア&運動コーチングAI</title>
    
    <!-- ファビコン -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    
    <!-- PWA設定 -->
    <!-- <meta name="apple-mobile-web-app-capable" content="yes"> -->
    <!-- <meta name="apple-mobile-web-app-status-bar-style" content="default"> -->
    <!-- <meta name="apple-mobile-web-app-title" content="FitAI"> -->
    <!-- <meta name="theme-color" content="#0066cc"> -->
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Date picker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 25%, #ff1744 75%, #e91e63 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.05) 50%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            backdrop-filter: blur(20px);
            box-shadow: 0 12px 40px rgba(255, 107, 53, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #ff6b35, #f7931e, #ff1744, transparent);
            animation: energyPulse 2s infinite;
        }

        @keyframes energyPulse {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .logo {
            width: 300px;
            max-width: 100%;
            height: auto;
            margin-bottom: 15px;
        }

        .header h1 {
            background: linear-gradient(135deg, #ff6b35, #ff1744);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 3em;
            margin-bottom: 15px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(255, 107, 53, 0.1);
        }

        .header p {
            color: #555;
            font-size: 1.1em;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
            font-weight: 500;
        }

        .nav-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 25px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 10;
        }

        .nav-tabs {
        display: flex !important;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: center;
        overflow-x: auto;
        padding: 5px;
        }

        .nav-tab {
            flex: 0 0 auto !important;
            min-width: 180px;
            padding: 18px 24px;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 15px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 700;
            font-size: 14px;
            text-align: center;
            text-decoration: none;
            display: flex !important;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 107, 53, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab:hover {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(255, 23, 68, 0.1));
            color: #ff6b35;
            border-color: rgba(255, 107, 53, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.2);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #ff6b35, #ff1744);
            color: white;
            border-color: #ff6b35;
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.4);
            transform: translateY(-2px);
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 500px;
        }

        .page {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 1.8em;
            color: #a855f7;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input:not([type="checkbox"]):not([type="radio"]),
        .form-group select,
        .form-group textarea {
          width: 100%;
          padding: 12px 16px;
          border: 2px solid #e1e5e9;
          border-radius: 10px;
          font-size: 16px;
          transition: all 0.3s ease;
          background: white;
        }

        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.15);
            transform: translateY(-1px);
        }

        .btn {
            background: linear-gradient(135deg, #ff6b35, #ff1744);
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 160px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(255, 107, 53, 0.4);
            background: linear-gradient(135deg, #ff8a65, #ff1744);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20963d);
        }

        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .tabs-container {
            margin-bottom: 30px;
        }


        .upload-area {
            border: 3px dashed #ff6b35;
            border-radius: 20px;
            padding: 50px 30px;
            text-align: center;
            margin: 25px 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.03), rgba(255, 23, 68, 0.02));
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 107, 53, 0.05), transparent);
            animation: rotate 3s linear infinite;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .upload-area:hover::before {
            opacity: 1;
        }

        .upload-area:hover {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.08), rgba(255, 23, 68, 0.05));
            border-color: #ff8a65;
            transform: scale(1.02);
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.2);
        }

        .upload-area.drag-over {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.15), rgba(255, 23, 68, 0.1));
            border-color: #ff1744;
            transform: scale(1.05);
            box-shadow: 0 12px 40px rgba(255, 107, 53, 0.3);
        }

        .file-input {
            display: none;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status-success {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid rgba(40, 167, 69, 0.3);
            color: #155724;
        }

        .status-error {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid rgba(220, 53, 69, 0.3);
            color: #721c24;
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid rgba(255, 193, 7, 0.3);
            color: #856404;
        }

        /* 既往歴の多項目選択 */
        .multiselect-dropdown {
            position: relative;
        }

        .multiselect-selected {
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 10px;
            background: white;
            cursor: pointer;
        }

        .multiselect-options {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            width: 100%;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            z-index: 1000;
            display: none;
        }

        .multiselect-option {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin: 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #f8f9fa;
            border: 1px solid transparent;
        }

        .multiselect-option:hover {
            background: rgba(255, 107, 53, 0.1);
            border-color: rgba(255, 107, 53, 0.3);
        }

        .multiselect-option input {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .multiselect-option label {
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin: 0;
        }

        .multiselect-option.selected {
            background: rgba(255, 107, 53, 0.1);
            border-color: #ff6b35;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-canvas {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: white;
            border-radius: 18px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 6px 25px rgba(255, 107, 53, 0.1);
            border: 2px solid rgba(255, 107, 53, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b35, #f7931e, #ff1744);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .metric-card:hover::before {
            transform: scaleX(1);
        }

        .metric-card:hover {
            border-color: #ff6b35;
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(255, 107, 53, 0.2);
        }

        .metric-value {
            font-size: 2.2em;
            font-weight: 900;
            background: linear-gradient(135deg, #ff6b35, #ff1744);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .metric-label {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .coaching-result {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.05), rgba(255, 23, 68, 0.03));
            border-radius: 20px;
            padding: 30px;
            margin: 25px 0;
            border-left: 6px solid #ff6b35;
            line-height: 1.8;
            border: 1px solid rgba(255, 107, 53, 0.2);
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.1);
        }

        .coaching-result h3 {
            background: linear-gradient(135deg, #ff6b35, #ff1744);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            font-weight: 800;
        }

        .date-range-container {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .period-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 8px 16px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .period-btn.active {
            border-color: #a855f7;
            background: linear-gradient(135deg, #a855f7, #3b82f6);
            color: white;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .error-message {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 5px;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 8px;
            }
            
            .nav-tab {
                min-width: auto;
                width: 100%;
                margin-bottom: 0;
            }
            
            .content {
                padding: 20px 15px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .date-range-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .period-buttons {
                justify-content: center;
            }

            .multiselect-container {
                grid-template-columns: 1fr;
            }
        }

        /* PWA用のスタイル */
        .pwa-install-banner {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b35, #ff1744);
            color: white;
            padding: 18px;
            border-radius: 15px;
            display: none;
            z-index: 1000;
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .pwa-install-banner.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .meal-table-container {
            margin-top: 20px;
            overflow-x: auto;
        }

        #meals-table {
            width: 100%;
            border-collapse: collapse;
        }
        #meals-table th, #meals-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        #meals-table th {
            background-color: #f9f9f9;
        }

        .coach-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }

        .coach-option {
            width: 180px;
            border: 2px dashed #ccc;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 10px;
            background: #fff;
            text-align: center;
        }

        .coach-option img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .coach-name {
            font-weight: 700;
            margin-bottom: 5px;
        }

        .coach-intro {
            font-size: 0.85em;
            color: #555;
        }

        .coach-option.selected {
            border-color: #ff6b35;
            background: rgba(255,107,53,0.1);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ヘッダー -->
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 15px;">
                <div style="font-size: 4em; filter: drop-shadow(0 4px 8px rgba(255, 107, 53, 0.3));">💪</div>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                    <img src="/static/logo.png" alt="FitAI Logo" style="height: 100px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <h1 style="display: none;">FitAI</h1>
                </div>
                <div style="font-size: 4em; filter: drop-shadow(0 4px 8px rgba(255, 107, 53, 0.3));">🔥</div>
            </div>
            <p>FitAIは、あなたの体のデータ・生活習慣・目標に合わせて、科学的根拠に基づいた最適な行動プランを提案するパーソナルヘルスコーチAIです。💪 今すぐフィットネスジャーニーを始めましょう！ 🚀</p>
        </div>

        <!-- ナビゲーション -->
        <div class="nav-container">
            <div class="nav-tabs">
                <button class="nav-tab active" data-page="profile">💪 ユーザー情報入力</button>
                <button class="nav-tab" data-page="meal">🍚 食事画像アップロード</button>
                <button class="nav-tab" data-page="coaching">🏋️ AIコーチング</button>
                <button class="nav-tab" data-page="dashboard">📊 ダッシュボード</button>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="content">
            <!-- ユーザー情報入力ページ -->
            <div id="profile" class="page active">
                <div class="section-title">
                    💪 あなたの情報を入力して、パーソナルプランを作りましょう
                </div>
                <p style="margin-bottom: 30px; color: #666; font-weight: 500;">入力後「保存する」をクリック 🚀<br>※初回入力だけでOK。内容を変更したいときだけ更新してください。</p>
                
                <form id="profile-form">
                    <div class="form-grid">
                        <div>
                            <div class="form-group">
                                <label>年齢</label>
                                <input type="number" id="age" min="0" max="120" placeholder="年齢を入力">
                            </div>
                            <div class="form-group">
                                <label>性別</label>
                                <select id="sex">
                                    <option value="">選択してください</option>
                                    <option value="male">男性</option>
                                    <option value="female">女性</option>
                                    <option value="other">その他</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>身長 (cm)</label>
                                <input type="number" id="height_cm" step="0.1" placeholder="身長を入力">
                            </div>
                            <div class="form-group">
                                <label>現体重 (kg)</label>
                                <input type="number" id="weight_kg" step="0.1" placeholder="現在の体重を入力">
                            </div>
                            <div class="form-group">
                                <label>目標体重 (kg)</label>
                                <input type="number" id="target_weight_kg" step="0.1" placeholder="目標体重を入力">
                            </div>
                        </div>
                        
                        <div>
                            <div class="form-group">
                                <label>運動目的（自由記述）</label>
                                <textarea id="goal" rows="3" placeholder="例）減量と体力向上。週3回の有酸素＋軽い筋トレ"></textarea>
                            </div>
                            <div class="form-group">
                                <label>アレルギー情報</label>
                                <input type="text" id="allergies" placeholder="例）そば、ピーナッツ">
                            </div>
                            <div class="form-group">
                                <label>喫煙頻度（週あたり）</label>
                                <select id="smoking_status">
                                    <option value="never">なし</option>
                                    <option value="former">以前は吸っていた</option>
                                    <option value="current">現在吸っている</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>飲酒頻度（週あたり）</label>
                                <select id="alcohol_habit">
                                    <option value="none">なし</option>
                                    <option value="social">1〜3日</option>
                                    <option value="moderate">4〜6日</option>
                                    <option value="heavy">毎日</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>既往歴（該当を選択※複数選択可）</label>
                        <div class="multiselect-dropdown">
                            <div class="multiselect-selected" id="past-history-selected">選択してください</div>
                            <div class="multiselect-options" id="past-history-options">
                                <!-- 動的に生成 -->
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>現在の服薬内容</label>
                        <textarea id="medications" rows="3" placeholder="例）降圧薬（アムロジピン5mg）朝1錠 など"></textarea>
                    </div>

                    <button type="submit" class="btn btn-success" style="width: 100%; font-size: 1.1em; padding: 20px;">
                        💾 プロフィールを保存
                    </button>
                </form>

                <div id="profile-status"></div>
            </div>

            <!-- 食事画像アップロードページ -->
            <div id="meal" class="page">
                <div class="section-title">
                    🍚 毎日お食事の写真をアップして、健康記録を続けましょう
                </div>
                <p style="margin-bottom: 30px; color: #666; font-weight: 500;">画像アップロード後「登録する」をクリック 📸✨</p>

                <div class="tabs-container">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>日付</label>
                            <input type="date" id="meal-date">
                        </div>
                        <div class="form-group">
                            <label>時刻</label>
                            <input type="time" id="meal-time">
                        </div>
                    </div>

                    <div class="upload-area" id="upload-area">
                        <div style="font-size: 4em; margin-bottom: 20px; filter: drop-shadow(0 4px 8px rgba(255, 107, 53, 0.3));">📸</div>
                        <h3 style="font-weight: 800; font-size: 1.3em; margin-bottom: 15px;">画像をここにドラッグ&ドロップ</h3>
                        <p style="font-weight: 600; margin-bottom: 20px;">または</p>
                        <button type="button" class="btn" style="margin-top: 15px;" onclick="document.getElementById('file-input').click()">
                            📁 ファイルを選択
                        </button>
                        <input type="file" id="file-input" class="file-input" accept="image/*">
                    </div>

                    <div id="preview-container" style="display: none;">
                        <img id="preview-image" class="preview-image" alt="プレビュー">
                    </div>

                    <div class="form-group">
                        <label>メモ（任意）</label>
                        <input type="text" id="meal-memo" placeholder="例）ご飯大盛り など">
                    </div>

                    <button type="button" class="btn btn-success" id="upload-btn" disabled style="width: 100%; font-size: 1.1em; padding: 20px;">
                        🚀 食事を登録する
                    </button>
                </div>

                <div id="meal-status"></div>
            </div>

            <!-- AIコーチングページ -->
            <div id="coaching" class="page">
                <div class="section-title">
                    😃 コーチ選択
                </div>
                <div class="coach-grid">
                    <div class="coach-option" data-character="A">
                        <img src="/static/coach_A.png" alt="朝日 太陽">
                        <div class="coach-name">朝日 太陽</div>
                        <div class="coach-intro">君の努力は全部オレが見逃さないぞ！どんな小さな一歩だって最高の成長だ。さあ、一緒にもっと強くなろうぜ！</div>
                    </div>
                    <div class="coach-option" data-character="B">
                        <img src="/static/coach_B.png" alt="黒崎 刃">
                        <div class="coach-name">黒崎 刃</div>
                        <div class="coach-intro">甘えは許さない。言い訳なんて無駄だ。だが…本気で変わる覚悟があるなら、オレが鍛えてやる。</div>
                    </div>
                    <div class="coach-option" data-character="C">
                        <img src="/static/coach_C.png" alt="桜井 美優">
                        <div class="coach-name">桜井 美優</div>
                        <div class="coach-intro">あなたの頑張りをそっと見守って、一緒に喜んでいきたいな。無理しすぎず、でも少しずつ前に進もうね。</div>
                    </div>
                    <div class="coach-option" data-character="D">
                        <img src="/static/coach_D.png" alt="神崎 燐">
                        <div class="coach-name">神崎 燐</div>
                        <div class="coach-intro">ほんっと情けないんだから…でも、少しは期待してるんだからね。ちゃんと結果で見せなさいよ！</div>
                    </div>
                </div>

                
                <div class="section-title" style="margin-top: 40px;>
                    🏋️ AIコーチからアドバイスを受けましょう
                </div>
                <p style="margin-bottom: 30px; color: #666; font-weight: 500;">直近7日間のデータをもとに、AIコーチがあなた専用のアドバイスをお届けします。💪🔥</p>

                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="show-prompt">
                        <span>送信プロンプトを表示</span>
                    </label>
                </div>

                <button type="button" class="btn btn-success" id="coaching-btn" style="width: 100%; font-size: 1.2em; padding: 25px;">
                    🎯 コーチングを実行する
                </button>

                <div id="coaching-status"></div>
                <div id="coaching-result"></div>
                <div id="coaching-prompt" style="display: none;"></div>
            </div>

            <!-- ダッシュボードページ -->
            <div id="dashboard" class="page">
                <div class="section-title">
                    📊 計測結果の推移
                </div>

                <div class="date-range-container">
                    <div>
                        <label style="font-weight: 700; color: #ff6b35;">期間を選択</label>
                        <input type="date" id="start-date">
                    </div>
                    <div>
                        <label style="font-weight: 700; color: #ff6b35;">〜</label>
                        <input type="date" id="end-date">
                    </div>
                    <button class="btn" id="update-dashboard">
                        🔄 更新
                    </button>
                </div>

                <div class="period-buttons">
                    <button class="period-btn active" data-days="7">過去7日</button>
                    <button class="period-btn" data-days="14">過去14日</button>
                    <button class="period-btn" data-days="30">過去30日</button>
                    <button class="period-btn" data-days="90">過去90日</button>
                </div>

                <div class="dashboard-grid">
                    <div class="chart-container">
                        <div class="chart-title">
                            🔥 カロリー収支（消費・摂取カロリー）
                        </div>
                        <div class="chart-canvas">
                            <canvas id="calorie-chart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">
                            📈 体重変化
                        </div>
                        <div class="chart-canvas">
                            <canvas id="weight-change-chart"></canvas>
                        </div>
                        <div id="weight-change-summary" class="metric-card" style="margin-top: 15px;">
                            <div class="metric-value" id="total-weight-change">--</div>
                            <div class="metric-label">期間中の体重変化 (理論値)</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">
                            ⚖️ 体重推移
                        </div>
                        <div class="chart-canvas">
                            <canvas id="weight-chart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">
                            📉 体脂肪率推移
                        </div>
                        <div class="chart-canvas">
                            <canvas id="body-fat-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="meal-table-container">
                    <h3>🍽️ 食事一覧</h3>
                    <table id="meals-table">
                        <thead><tr></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="dashboard-status"></div>
            </div>
        </div>

        <!-- PWAインストールバナー -->
        <div id="pwa-install-banner" class="pwa-install-banner">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>📱 アプリとしてインストール</strong>
                    <div style="font-size: 14px; opacity: 0.9;">ホーム画面に追加してより便利に使えます</div>
                </div>
                <div>
                    <button class="btn" id="pwa-install-btn" style="margin-right: 10px;">インストール</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('pwa-install-banner').classList.remove('show')">後で</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // アプリケーション状態管理
        class FitAIApp {
            constructor() {
                this.currentPage = 'profile';
                this.apiBaseUrl = '';
                this.apiToken = localStorage.getItem('fitai_api_token') || '';
                this.charts = {};
                this.selectedFile = null;
                this.isUploading = false;
                this.selectedCoach = localStorage.getItem('fitai_coach') || 'A';
                // PASTEされたデータに基づく既往歴オプション
                this.pastHistoryOptions = [
                    {value: 'hypertension', label: '高血圧'},
                    {value: 'diabetes', label: '糖尿病'},
                    {value: 'cad', label: '心疾患'},
                    {value: 'stroke', label: '脳卒中（脳梗塞・脳出血）'},
                    {value: 'asthma', label: '気管支喘息'},
                    {value: 'copd', label: '慢性閉塞性肺疾患（COPD）'},
                    {value: 'ulcer', label: '胃潰瘍・十二指腸潰瘍'},
                    {value: 'hepatitis', label: '肝炎（B型・C型）'},
                    {value: 'kidney', label: '慢性腎不全'},
                    {value: 'cancer', label: '悪性腫瘍（がん）'},
                    {value: 'osteoporosis', label: '骨粗鬆症'},
                    {value: 'ra', label: '関節リウマチ'},
                    {value: 'depression', label: 'うつ病'},
                    {value: 'epilepsy', label: 'てんかん'},
                    {value: 'drug_allergy', label: '薬剤アレルギー'},
                    {value: 'other', label: 'その他'}
                ];
                this.initializeApp();
            }


            // アプリケーション初期化
            initializeApp() {
                this.setupEventListeners();
                this.setupPWA();
                this.setupPastHistoryMultiselect();
                this.loadProfile();
                this.setupMealUpload();
                this.restoreState();
                
                // デフォルトの日付設定
                const today = new Date();
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(today.getDate() - 6);

                document.getElementById('start-date').value = this.formatDate(sevenDaysAgo);
                document.getElementById('end-date').value = this.formatDate(today);
                this.setDefaultMealDateTime();
                this.selectCoach(this.selectedCoach);
            }

            // イベントリスナー設定
            setupEventListeners() {
                // ナビゲーション
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const page = e.currentTarget.dataset.page;
                        this.navigateToPage(page);
                    });
                });

                // コーチキャラクター選択
                document.querySelectorAll('.coach-option').forEach(opt => {
                    opt.addEventListener('click', (e) => {
                        this.selectCoach(e.currentTarget.dataset.character);
                    });
                });

                // プロフィールフォーム
                document.getElementById('profile-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveProfile();
                });

                // ファイルアップロード
                document.getElementById('upload-btn').addEventListener('click', () => {
                    this.uploadMeal();
                });

                // コーチング実行
                document.getElementById('coaching-btn').addEventListener('click', () => {
                    this.runCoaching();
                });

                // ダッシュボード更新
                document.getElementById('update-dashboard').addEventListener('click', () => {
                    this.updateDashboard();
                });

                // 期間ボタン
                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.setPeriod(parseInt(e.target.dataset.days));
                    });
                });

                // ブラウザの戻る/進むボタン
                window.addEventListener('popstate', (event) => {
                    if (event.state && event.state.page) {
                        this.currentPage = event.state.page;
                        this.showPage(this.currentPage);
                    }
                });
            }

            // PWA設定
            setupPWA() {
                let deferredPrompt;

                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    document.getElementById('pwa-install-banner').classList.add('show');
                });

                document.getElementById('pwa-install-btn').addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            document.getElementById('pwa-install-banner').classList.remove('show');
                        }
                        deferredPrompt = null;
                    }
                });

                // サービスワーカー登録（オプション）
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('/sw.js')
                            .then((registration) => {
                                console.log('SW registered: ', registration);
                            })
                            .catch((registrationError) => {
                                console.log('SW registration failed: ', registrationError);
                            });
                    });
                }
            }

            // 既往歴マルチセレクト設定
            setupPastHistoryMultiselect() {
                const optionsContainer = document.getElementById('past-history-options');
                const selectedDisplay = document.getElementById('past-history-selected');
                optionsContainer.innerHTML = '';

                this.pastHistoryOptions.forEach(option => {
                    const div = document.createElement('div');
                    div.className = 'multiselect-option';
                    div.innerHTML = `
                        <input type="checkbox" id="past-${option.value}" value="${option.value}">
                        <label for="past-${option.value}">${option.label}</label>
                    `;

                    const checkbox = div.querySelector('input');
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            div.classList.add('selected');
                        } else {
                            div.classList.remove('selected');
                        }
                        this.updatePastHistorySelected();
                    });

                    div.addEventListener('click', (e) => {
                      if (e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL') return;
                      checkbox.checked = !checkbox.checked;
                      checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                    });

                    optionsContainer.appendChild(div);
                });

                selectedDisplay.addEventListener('click', () => {
                    optionsContainer.style.display = optionsContainer.style.display === 'block' ? 'none' : 'block';
                });

                document.addEventListener('click', (e) => {
                    if (!optionsContainer.contains(e.target) && !selectedDisplay.contains(e.target)) {
                        optionsContainer.style.display = 'none';
                    }
                });

                this.updatePastHistorySelected();
            }

            updatePastHistorySelected() {
                const selectedDisplay = document.getElementById('past-history-selected');
                if (!selectedDisplay) return;
                const selectedLabels = [];
                this.pastHistoryOptions.forEach(option => {
                    const checkbox = document.getElementById(`past-${option.value}`);
                    if (checkbox && checkbox.checked) {
                        selectedLabels.push(option.label);
                    }
                });
                selectedDisplay.textContent = selectedLabels.length ? selectedLabels.join('、') : '選択してください';
            }

            // 食事アップロード設定
            setupMealUpload() {
                const uploadArea = document.getElementById('upload-area');
                const fileInput = document.getElementById('file-input');
                const previewContainer = document.getElementById('preview-container');
                const previewImage = document.getElementById('preview-image');
                const uploadBtn = document.getElementById('upload-btn');

                // ドラッグ&ドロップ
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('drag-over');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('drag-over');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFileSelect(files[0]);
                    }
                });

                // ファイル選択
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFileSelect(e.target.files[0]);
                    }
                });
            }

            // ファイル選択処理
            handleFileSelect(file) {
                if (!file.type.startsWith('image/')) {
                    this.showStatus('meal-status', '画像ファイルを選択してください', 'error');
                    return;
                }

                this.selectedFile = file;
                
                // プレビュー表示
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('preview-image').src = e.target.result;
                    document.getElementById('preview-container').style.display = 'block';
                    document.getElementById('upload-btn').disabled = false;
                };
                reader.readAsDataURL(file);
            }

            // ページナビゲーション
            navigateToPage(pageId) {
                this.currentPage = pageId;
                this.showPage(pageId);
                this.saveState();
                
                // URLを更新
                history.pushState({page: pageId}, '', `#${pageId}`);
                
                // ページ固有の処理
                if (pageId === 'dashboard') {
                    if (Object.keys(this.charts).length === 0) {
                        this.initializeDashboard();
                    }
                    setTimeout(() => {
                        Object.values(this.charts).forEach(chart => chart.resize());
                        this.updateDashboard();
                    }, 100);
                }
            }

            // ページ表示
            showPage(pageId) {
                // 全ページを非表示
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                
                // 全タブを非アクティブ
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // 指定ページを表示
                const targetPage = document.getElementById(pageId);
                const targetTab = document.querySelector(`[data-page="${pageId}"]`);
                
                if (targetPage) {
                    targetPage.classList.add('active');
                }
                
                if (targetTab) {
                    targetTab.classList.add('active');
                }

                // 食事ページ表示時に現在日時を設定
                if (pageId === 'meal') {
                    this.setDefaultMealDateTime();
                }
            }

            // API呼び出しヘルパー
            async apiCall(endpoint, options = {}) {
                const headers = {
                    ...options.headers
                };

                // JSON送信でない場合（FormDataなど）はContent-Typeを設定しない
                if (!(options.body instanceof FormData)) {
                    headers['Content-Type'] = 'application/json';
                }

                if (this.apiToken) {
                    headers['x-api-token'] = this.apiToken;
                }

                // APIコールのデバウンス（500ms）
                const now = Date.now();
                if (this._lastApiCallTime && now - this._lastApiCallTime < 500) {
                    await new Promise(resolve => setTimeout(resolve, 500 - (now - this._lastApiCallTime)));
                }
                this._lastApiCallTime = Date.now();

                try {
                    const response = await fetch(`${this.apiBaseUrl}${endpoint}`, {
                        ...options,
                        headers
                    });
                    
                    if (!response.ok) {
                        // 401エラーの場合、トークンなしで再試行
                        if (response.status === 401 && this.apiToken) {
                            console.log('401 error detected, retrying without token...');
                            const headersWithoutToken = { ...headers };
                            delete headersWithoutToken['x-api-token'];
                            
                            const retryResponse = await fetch(`${this.apiBaseUrl}${endpoint}`, {
                                ...options,
                                headers: headersWithoutToken
                            });
                            
                            if (retryResponse.ok) {
                                return await retryResponse.json();
                            }
                        }
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error(`API call failed for ${endpoint}:`, error);
                    throw error;
                }
            }

            // プロフィール読み込み
            async loadProfile() {
                try {
                    const response = await this.apiCall('/ui/profile');
                    const profile = response.profile || {};
                    
                    // フォームに値をセット
                    Object.keys(profile).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && profile[key] !== null && profile[key] !== undefined) {
                            if (element.type === 'checkbox') {
                                element.checked = profile[key];
                            } else {
                                element.value = profile[key];
                            }
                        }
                    });

                    // 既往歴の設定
                    if (profile.past_history && Array.isArray(profile.past_history)) {
                        const jp2eng = {
                            "高血圧": "hypertension",
                            "糖尿病": "diabetes",
                            "心疾患": "cad",
                            "脳卒中（脳梗塞・脳出血）": "stroke",
                            "気管支喘息": "asthma",
                            "慢性閉塞性肺疾患（COPD）": "copd",
                            "胃潰瘍・十二指腸潰瘍": "ulcer",
                            "肝炎（B型・C型）": "hepatitis",
                            "慢性腎不全": "kidney",
                            "悪性腫瘍（がん）": "cancer",
                            "骨粗鬆症": "osteoporosis",
                            "関節リウマチ": "ra",
                            "うつ病": "depression",
                            "てんかん": "epilepsy",
                            "薬剤アレルギー": "drug_allergy",
                            "その他": "other"
                        };
                        profile.past_history.forEach(item => {
                            const value = jp2eng[item] || item;
                            const checkbox = document.getElementById(`past-${value}`);
                            if (checkbox) {
                                checkbox.checked = true;
                                checkbox.closest('.multiselect-option').classList.add('selected');
                            }
                        });
                        this.updatePastHistorySelected();
                    }

                } catch (error) {
                    console.error('Failed to load profile:', error);
                }
            }

            // プロフィール保存
            async saveProfile() {
                const saveBtn = document.querySelector('#profile-form button[type="submit"]');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<span class="loading-spinner"></span> 保存中...';
                }
                try {
                    const formData = new FormData(document.getElementById('profile-form'));
                    
                    // 既往歴の収集
                    const pastHistory = [];
                    this.pastHistoryOptions.forEach(option => {
                        const checkbox = document.getElementById(`past-${option.value}`);
                        if (checkbox && checkbox.checked) {
                            pastHistory.push(option.value);
                        }
                    });

                    const profileData = {
                        age: parseInt(document.getElementById('age').value) || null,
                        sex: document.getElementById('sex').value || null,
                        height_cm: parseFloat(document.getElementById('height_cm').value) || null,
                        weight_kg: parseFloat(document.getElementById('weight_kg').value) || null,
                        target_weight_kg: parseFloat(document.getElementById('target_weight_kg').value) || null,
                        goal: document.getElementById('goal').value || null,
                        allergies: document.getElementById('allergies').value || null,
                        smoking_status: document.getElementById('smoking_status').value || null,
                        alcohol_habit: document.getElementById('alcohol_habit').value || null,
                        past_history: pastHistory.length > 0 ? pastHistory : null,
                        medications: document.getElementById('medications').value || null
                    };

                    // null値を除去
                    Object.keys(profileData).forEach(key => {
                        if (profileData[key] === null || profileData[key] === '') {
                            delete profileData[key];
                        }
                    });

                    const result = await this.apiCall('/ui/profile', {
                        method: 'POST',
                        body: JSON.stringify(profileData)
                    });

                    if (result.ok) {
                        this.showStatus('profile-status', '✅ プロフィールを保存しました', 'success');
                        
                        // BigQuery同期結果を表示
                        if (result.bq && !result.bq.ok) {
                            this.showStatus('profile-status', `⚠️ 同期失敗: ${result.bq.reason || result.bq.error}`, 'warning', true);
                        } else if (result.bq && result.bq.ok) {
                            this.showStatus('profile-status', '✅ 同期完了', 'success', true);
                        }
                    } else {
                        throw new Error(result.error || 'Unknown error');
                    }

                    this.saveState();

                } catch (error) {
                    this.showStatus('profile-status', `❌ 保存に失敗しました: ${error.message}`, 'error');
                } finally {
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '💾 プロフィールを保存';
                    }
                }
            }

            // 食事アップロード
            async uploadMeal() {
                if (this.isUploading) {
                    return;
                }
                if (!this.selectedFile) {
                    this.showStatus('meal-status', '画像を選択してください', 'error');
                    return;
                }

                this.isUploading = true;
                const uploadBtn = document.getElementById('upload-btn');
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<span class="loading-spinner"></span> アップロード中...';

                try {
                    const mealDate = document.getElementById('meal-date').value;
                    const mealTime = document.getElementById('meal-time').value;
                    const mealMemo = document.getElementById('meal-memo').value;

                    const whenISO = `${mealDate}T${mealTime}:00`;

                    // FormData for file upload
                    const formData = new FormData();
                    formData.append('file', this.selectedFile);
                    formData.append('when', whenISO);
                    formData.append('memo', mealMemo);

                    // トークンがあればヘッダーに付与して1回だけ送信
                    const headers = this.apiToken ? { 'x-api-token': this.apiToken } : {};
                    const response = await fetch(`${this.apiBaseUrl}/ui/meal_image`, {
                        method: 'POST',
                        headers: headers,
                        body: formData
                    });

                    const responseClone = response.clone();

                    if (!response.ok) {
                        const text = await response.text();
                        const error = new Error(`Upload failed: ${response.status}`);
                        error.serverResponse = text;
                        throw error;
                    }

                    let result;
                    try {
                        result = await response.json();
                    } catch (parseError) {
                        const text = await responseClone.text();
                        const error = new Error(`Invalid JSON response: ${parseError.message}`);
                        error.serverResponse = text;
                        throw error;
                    }

                    if (result.ok) {
                        this.showStatus('meal-status', '✅ アップロード完了', 'success');
                        
                        if (result.preview) {
                            const previewDiv = document.createElement('div');
                            previewDiv.className = 'coaching-result';
                            previewDiv.innerHTML = `<h3>📝 画像要約</h3><p>${result.preview}</p>`;
                            document.getElementById('meal-status').appendChild(previewDiv);
                        }

                        // メモがある場合は追加で送信
                        if (mealMemo.trim()) {
                            try {
                                await this.apiCall('/ui/meal', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        when: whenISO,
                                        text: mealMemo,
                                        kcal: null
                                    })
                                });
                                this.showStatus('meal-status', '💬 メモも登録しました', 'success', true);
                            } catch (error) {
                                this.showStatus('meal-status', '⚠️ メモ保存に失敗（スキップ）', 'warning', true);
                            }
                        }

                        // フォームリセット
                        this.resetMealForm();
                    } else {
                        const error = new Error(result.error || 'Unknown error');
                        error.serverResponse = JSON.stringify(result);
                        throw error;
                    }

                } catch (error) {
                    const details = error.serverResponse ? `\nサーバー詳細: ${error.serverResponse}` : '';
                    this.showStatus('meal-status', `❌ アップロードに失敗しました: ${error.message}${details}`, 'error');
                } finally {
                    this.isUploading = false;
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '🚀 食事を登録する';
                }
            }

            // 日付・時刻の初期値を日本時間で設定
            setDefaultMealDateTime() {
                const now = new Date();
                document.getElementById('meal-date').value =
                    now.toLocaleDateString('en-CA', { timeZone: 'Asia/Tokyo' });
                document.getElementById('meal-time').value =
                    now.toLocaleTimeString('en-GB', {
                        timeZone: 'Asia/Tokyo',
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit'
                    });
            }

            // 食事フォームリセット
            resetMealForm() {
                this.selectedFile = null;
                document.getElementById('preview-container').style.display = 'none';
                document.getElementById('meal-memo').value = '';
                document.getElementById('file-input').value = '';
                document.getElementById('upload-btn').disabled = true;
                this.setDefaultMealDateTime();
            }

            // コーチキャラクター選択
            selectCoach(character) {
                this.selectedCoach = character;
                localStorage.setItem('fitai_coach', character);
                document.querySelectorAll('.coach-option').forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.character === character);
                });
            }

            // AIコーチング実行
            async runCoaching() {
                const coachingBtn = document.getElementById('coaching-btn');
                const showPrompt = document.getElementById('show-prompt').checked;
                
                coachingBtn.disabled = true;
                coachingBtn.innerHTML = '<span class="loading-spinner"></span> 実行中...';

                try {
                    const params = new URLSearchParams();
                    if (showPrompt) params.set('show_prompt', '1');
                    if (this.selectedCoach) params.set('character', this.selectedCoach);
                    const query = params.toString();
                    const response = await this.apiCall(`/coach/weekly${query ? `?${query}` : ''}`);

                    if (response.ok) {
                        this.showStatus('coaching-status', '✅ コーチングを実行しました', 'success');

                        if (response.preview) {
                            document.getElementById('coaching-result').innerHTML = `
                                <div class="coaching-result">
                                    <h3>📝 コーチからの提案</h3>
                                    <div style="white-space: pre-line;">${response.preview}</div>
                                </div>
                            `;
                        }

                        if (showPrompt && response.prompt) {
                            document.getElementById('coaching-prompt').innerHTML = `
                                <div class="coaching-result">
                                    <h3>🔍 送信プロンプト</h3>
                                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px;">${response.prompt}</pre>
                                </div>
                            `;
                            document.getElementById('coaching-prompt').style.display = 'block';
                        }
                    } else {
                        throw new Error(response.error || 'Unknown error');
                    }

                } catch (error) {
                    this.showStatus('coaching-status', `❌ 実行に失敗しました: ${error.message}`, 'error');
                } finally {
                    coachingBtn.disabled = false;
                    coachingBtn.innerHTML = '🎯 コーチングを実行する';
                }
            }

            // ダッシュボード初期化
            
// 既存チャートを安全に破棄するユーティリティ
safeDestroyChartByCanvasId(id) {
    const el = document.getElementById(id);
    if (!el) return null;
    let existing = null;
    try {
        existing = Chart.getChart ? Chart.getChart(el) : (el._chart || null);
        if (existing && typeof existing.destroy === 'function') {
            existing.destroy();
        }
    } catch (e) {
        console.warn('[dashboard] safeDestroyChartByCanvasId failed', e);
    }
    return existing;
}

initializeDashboard() {
                // Chart.js のデフォルト設定
                Chart.defaults.color = '#666';
                Chart.defaults.borderColor = 'rgba(0, 0, 0, 0.1)';

                // チャート作成
                this.createCalorieChart();
                this.createWeightChangeChart();
                this.createWeightChart();
            }

            // カロリーチャート作成
            createCalorieChart() {
                const ctx = document.getElementById('calorie-chart').getContext('2d');
                this.charts.calorie = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: '摂取カロリー',
                                data: [],
                                borderColor: '#ff1744',
                                backgroundColor: 'rgba(255, 23, 68, 0.1)',
                                borderWidth: 4,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#ff1744',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 3,
                                pointRadius: 6
                            },
                            {
                                label: '消費カロリー',
                                data: [],
                                borderColor: '#66bb6a',
                                backgroundColor: 'rgba(102, 187, 106, 0.1)',
                                borderWidth: 4,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#66bb6a',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 3,
                                pointRadius: 6
                            }
                        ]
                    },
                    options: this.getChartOptions('カロリー (kcal)')
                });
            }

            // 体重変化チャート作成
            createWeightChangeChart() {
                const ctx = document.getElementById('weight-change-chart').getContext('2d');
                this.charts.weightChange = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '体重変化 (kg)',
                            data: [],
                            backgroundColor: (context) => {
                                const value = context.parsed?.y;
                                if (value === undefined) {
                                    // 凡例描画時には value が未定義になるため、棒グラフと揃えた赤色を返す
                                    return 'rgba(255, 107, 107, 0.8)';
                                }
                                return value > 0
                                    ? 'rgba(255, 107, 107, 0.8)'
                                    : 'rgba(40, 167, 69, 0.8)';
                            },
                            borderColor: (context) => {
                                const value = context.parsed?.y;
                                if (value === undefined) {
                                    // 凡例用に赤色を返す
                                    return '#ff6b6b';
                                }
                                return value > 0 ? '#ff6b6b' : '#28a745';
                            },
                            borderWidth: 2
                        }]
                    },
                    options: this.getChartOptions('体重変化 (kg)')
                });
            }

            // 体重チャート作成
            createWeightChart() {
                const ctx = document.getElementById('weight-chart').getContext('2d');
                this.charts.weight = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '体重 (kg)',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: this.getChartOptions('体重 (kg)')
                });
            }

            // 体脂肪率チャート作成
            createBodyFatChart() {
                const ctx = document.getElementById('body-fat-chart').getContext('2d');
                this.charts.bodyFat = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '体脂肪率 (%)',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: this.getChartOptions('体脂肪率 (%)')
                });
            }

            // 共通チャートオプション
            getChartOptions(yAxisLabel) {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#666' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#666' },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yAxisLabel,
                                color: '#666'
                            }
                        }
                    }
                };
            }

            // ダッシュボード更新
            async updateDashboard() {
              const updateBtn = document.getElementById('update-dashboard');
              if (updateBtn) {
                updateBtn.disabled = true;
                updateBtn.innerHTML = '<span class="loading-spinner"></span> 更新中...';
              }
            
              const startDate = document.getElementById('start-date').value;
              const endDate   = document.getElementById('end-date').value;
            
              if (!startDate || !endDate) {
                this.showStatus('dashboard-status', '日付を選択してください', 'error');
                if (updateBtn) {
                  updateBtn.disabled = false;
                  updateBtn.innerHTML = '⟳ 更新';
                }
                return;
              }
            
              this.showStatus('dashboard-status', '📊 データ取得中...', 'warning');
            
              try {
                const response = await this.apiCall(
                  `/dashboard/summary?start_date=${startDate}&end_date=${endDate}&user_id=demo`
                );
            
                // ★追加：取得結果の可視化（不具合時の切り分け用）
                console.log('[dashboard] summary response', response);
            
                // ★ガード（想定フォーマットでなければ中断）
                if (!response || !response.data) {
                  this.showStatus('dashboard-status', 'データ取得に失敗しました', 'error');
                  return;
                }
                
                
// ★再描画前に既存チャートを安全に破棄し、参照をクリア
try {
  const destroyedCalorie = this.safeDestroyChartByCanvasId('calorie-chart');
  const destroyedWeightChange = this.safeDestroyChartByCanvasId('weight-change-chart');
  const destroyedWeight = this.safeDestroyChartByCanvasId('weight-chart');
  const destroyedBodyFat = this.safeDestroyChartByCanvasId('body-fat-chart');
  if (!this.charts) this.charts = {};
  if (destroyedCalorie || this.charts.calorie) this.charts.calorie = null;
  if (destroyedWeightChange || this.charts.weightChange) this.charts.weightChange = null;
  if (destroyedWeight || this.charts.weight) this.charts.weight = null;
  if (destroyedBodyFat || this.charts.bodyFat) this.charts.bodyFat = null;
} catch (e) {
  console.warn('[dashboard] destroy existing charts failed', e);
}

// ★チャート未生成でも落ちないよう保険（既に生成済なら何もしない）
                if (!this.charts) this.charts = {};
                if (!this.charts.calorie && this.createCalorieChart) this.createCalorieChart();
                if (!this.charts.weightChange && this.createWeightChangeChart) this.createWeightChangeChart();
                if (!this.charts.weight && this.createWeightChart) this.createWeightChart();
                if (!this.charts.bodyFat && this.createBodyFatChart) this.createBodyFatChart();
                
                // ★updateCharts を try-catch で囲む（描画エラーと通信エラーを分離）
                try {
                  this.updateCharts(response.data);
                } catch (e) {
                  console.error('[dashboard] updateCharts failed', e);
                  this.showStatus('dashboard-status', '描画時にエラーが発生しました', 'error');
                  return;
                }
                
                // 正常時
                this.showStatus('dashboard-status', '✅ 更新しました', 'success');
              } catch (e) {
                console.error('[dashboard] update error', e);
                this.showStatus('dashboard-status', `エラーが発生しました: ${e?.message || e}`, 'error');
              } finally {
                // 既存のボタン復帰（必ず実行）
                if (updateBtn) {
                  updateBtn.disabled = false;
                  updateBtn.innerHTML = '⟳ 更新';
                }
              }
            }

            // モックダッシュボードデータ生成
            generateMockDashboardData(startDate, endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

                const data = {
                    dates: [],
                    consumption_calories: [],
                    take_in_calories: [],
                    weight_change_kg: [],
                    weight_kg: [],
                    fat_percentage: []
                };

                let currentWeight = 70; // 初期体重

                for (let i = 0; i < days; i++) {
                    const date = new Date(start);
                    date.setDate(start.getDate() + i);
                    
                    const consumption = Math.floor(Math.random() * 500) + 1800;
                    const intake = Math.floor(Math.random() * 800) + 1500;
                    const weightChange = (intake - consumption) / 7700; // 簡易計算
                    
                    currentWeight += weightChange + (Math.random() - 0.5) * 0.2; // ノイズ追加

                    data.dates.push(date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
                    data.consumption_calories.push(consumption);
                    data.take_in_calories.push(intake);
                    data.weight_change_kg.push(weightChange);
                    data.weight_kg.push(currentWeight);
                    data.fat_percentage.push(20 + (Math.random() - 0.5) * 5);
                }

                return data;
            }

            // チャート更新
            updateCharts(data) {
              // --- 追加: 受け取ったデータのログ（切り分け用）
              console.log('[updateCharts] input', data);
            
              // --- 追加: チャートの存在チェック（未生成なら生成）
              if (!this.charts) this.charts = {};
              try {
                if (!this.charts.calorie && this.createCalorieChart) this.createCalorieChart();
                if (!this.charts.weightChange && this.createWeightChangeChart) this.createWeightChangeChart();
                if (!this.charts.weight && this.createWeightChart) this.createWeightChart();
                if (!this.charts.bodyFat && this.createBodyFatChart) this.createBodyFatChart();
              } catch (e) {
                console.error('[updateCharts] chart init error', e);
                throw e; // ここで落ちたら try-catch 側でメッセージ表示
              }
            
              // 既存の検証
              if (!data || !data.dates || !Array.isArray(data.dates)) {
                console.error('Invalid data structure:', data);
                throw new Error('データの形式が正しくありません');
              }
            
              // 以降は既存の更新処理のまま
              this.charts.calorie.data.labels = data.dates;
              this.charts.calorie.data.datasets[0].data = data.take_in_calories || [];
              this.charts.calorie.data.datasets[1].data = data.consumption_calories || [];
              this.charts.calorie.update();
            
              this.charts.weightChange.data.labels = data.dates;
              const weightChangeData = (data.weight_change_kg || []).map(v => v ?? 0);
              this.charts.weightChange.data.datasets[0].data = weightChangeData;
              this.charts.weightChange.update();

              // 期間中の体重変化を合計しサマリーカードに表示
              const totalWeightChange = weightChangeData.reduce((sum, value) => sum + value, 0);
              const summaryEl = document.getElementById('total-weight-change');
              if (summaryEl) {
                const sign = totalWeightChange > 0 ? '+' : '';
                summaryEl.textContent = `${sign}${totalWeightChange.toFixed(2)} kg`;
              }

              this.charts.weight.data.labels = data.dates;
              this.charts.weight.data.datasets[0].data = data.weight_kg || [];
              this.charts.weight.update();

              if (this.charts.bodyFat) {
                this.charts.bodyFat.data.labels = data.dates;
                this.charts.bodyFat.data.datasets[0].data = data.fat_percentage || [];
                this.charts.bodyFat.update();
              }

              if (data.meals_by_date) {
                this.renderMealsTable(data.meals_by_date);
              }

              // 既存のサマリー更新はそのまま
            }

            renderMealsTable(mealsByDate) {
              const table = document.querySelector('#meals-table');
              if (!table) return;
              const tbody = table.querySelector('tbody');
              const theadRow = table.querySelector('thead tr');
              tbody.innerHTML = '';
              theadRow.innerHTML = '';

              const dates = Object.keys(mealsByDate || {}).sort();
              let columns = [];

              for (const date of dates) {
                const meals = mealsByDate[date] || [];
                if (meals.length > 0) {
                  columns = Object.keys(meals[0]).filter(col => col !== 'source');
                  break;
                }
              }

              theadRow.innerHTML = ['<th>日付</th>', ...columns.map(c => `<th>${c}</th>`)].join('');

              for (const date of dates) {
                const meals = mealsByDate[date] || [];
                if (meals.length === 0) {
                  const tr = document.createElement('tr');
                  const colspan = Math.max(columns.length, 1);
                  tr.innerHTML = `<td>${date}</td><td colspan="${colspan}">--</td>`;
                  tbody.appendChild(tr);
                  continue;
                }
                for (const meal of meals) {
                  const tr = document.createElement('tr');
                  const cells = columns.map(col => {
                    const val = meal[col] !== undefined && meal[col] !== null ? meal[col] : '';
                    return `<td>${val}</td>`;
                  }).join('');
                  tr.innerHTML = `<td>${date}</td>${cells}`;
                  tbody.appendChild(tr);
                }
              }
            }

            // 期間設定
            setPeriod(days) {
                const end = new Date();
                const start = new Date(end);
                start.setDate(end.getDate() - (days - 1));

                document.getElementById('start-date').value = this.formatDate(start);
                document.getElementById('end-date').value = this.formatDate(end);

                // ボタンの状態更新
                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-days="${days}"]`).classList.add('active');

                this.updateDashboard();
            }

            // ステータス表示
            showStatus(containerId, message, type, append = false) {
                const container = document.getElementById(containerId);
                const statusDiv = document.createElement('div');
                statusDiv.className = `status-message status-${type}`;
                statusDiv.textContent = message;

                if (!append) {
                    container.innerHTML = '';
                }
                container.appendChild(statusDiv);

                // 自動削除（エラー以外）
                if (type !== 'error') {
                    setTimeout(() => {
                        statusDiv.remove();
                    }, 5000);
                }
            }

            // 状態保存
            saveState() {
                const state = {
                    currentPage: this.currentPage,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('fitai_app_state', JSON.stringify(state));
            }

            // 状態復元
            restoreState() {
                const saved = localStorage.getItem('fitai_app_state');
                if (saved) {
                    try {
                        const state = JSON.parse(saved);
                        if (state.currentPage) {
                            this.currentPage = state.currentPage;
                            this.showPage(this.currentPage);
                        }
                    } catch (error) {
                        console.error('Failed to restore state:', error);
                    }
                }
            }

            // 日付フォーマット
            formatDate(date) {
                return date.toISOString().split('T')[0];
            }
        }

        // アプリケーション初期化
        let app;

        document.addEventListener('DOMContentLoaded', () => {
            app = new FitAIApp();
        });

        // PWA用のマニフェスト生成
        const manifest = {
            "name": "FitAI - ヘルスケア&運動コーチングAI",
            "short_name": "FitAI",
            "description": "AIによるヘルスケアと運動コーチングアプリ",
            "icons": [
                {
                    "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIHJ4PSI0OCIgZmlsbD0iIzAwNjZjYyIvPjx0ZXh0IHg9Ijk2IiB5PSIxMTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI4MCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPvCfj4PigI3imYI8L3RleHQ+PC9zdmc+",
                    "sizes": "192x192",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                },
                {
                    "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIHJ4PSIxMjgiIGZpbGw9IiMwMDY2Y2MiLz48dGV4dCB4PSIyNTYiIHk9IjMwMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjIwMCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPvCfkqo8L3RleHQ+PC9zdmc+",
                    "sizes": "512x512",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                }
            ],
            "theme_color": "#ff6b35",
            "background_color": "#ffffff",
            "display": "browser",
            "start_url": "/",
            "scope": "/"
        };

        // マニフェストをHTML headに追加
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);

        // APIトークン設定用の関数（デバッグ用）
        function setApiToken(token) {
            localStorage.setItem('fitai_api_token', token);
            if (app) {
                app.apiToken = token;
            }
            console.log('API token set successfully');
        }

        // APIトークン削除用の関数（デバッグ用）
        function clearApiToken() {
            localStorage.removeItem('fitai_api_token');
            if (app) {
                app.apiToken = '';
            }
            console.log('API token cleared successfully');
        }

        // APIベースURL設定用の関数（デバッグ用）
        function setApiBaseUrl(url) {
            if (app) {
                app.apiBaseUrl = url;
            }
            console.log('API base URL set to:', url);
        }

        // コンソールにデバッグ情報を表示
        console.log('%cFitAI アプリケーション', 'color: #ff6b35; font-size: 20px; font-weight: bold;');
        console.log('🔧 デバッグ用コマンド:');
        console.log('  clearApiToken() - APIトークンを削除（401エラー解決）');
        console.log('  setApiToken("your-token") - APIトークンを設定');
        console.log('  setApiBaseUrl("http://localhost:8080") - APIベースURLを設定');
        console.log('  app - アプリケーションインスタンスにアクセス');

        // // サービスワーカー用コード（オプション）
        // const swCode = `
        //     const CACHE_NAME = 'fitai-v1';
        //     const urlsToCache = [
        //         '/',
        //         '/manifest.json'
        //     ];

        //     self.addEventListener('install', function(event) {
        //         event.waitUntil(
        //             caches.open(CACHE_NAME)
        //                 .then(function(cache) {
        //                     return cache.addAll(urlsToCache);
        //                 })
        //         );
        //     });

        //     self.addEventListener('fetch', function(event) {
        //         event.respondWith(
        //             caches.match(event.request)
        //                 .then(function(response) {
        //                     if (response) {
        //                         return response;
        //                     }
        //                     return fetch(event.request);
        //                 }
        //             )
        //         );
        //     });
        // `;

        // // サービスワーカーをBlob URLとして作成
        // const swBlob = new Blob([swCode], {type: 'application/javascript'});
        // const swURL = URL.createObjectURL(swBlob);

        // // サービスワーカー登録
        // if ('serviceWorker' in navigator) {
        //     window.addEventListener('load', () => {
        //         navigator.serviceWorker.register(swURL)
        //             .then((registration) => {
        //                 console.log('🔧 Service Worker registered successfully');
        //             })
        //             .catch((registrationError) => {
        //                 console.log('⚠️ Service Worker registration failed:', registrationError);
        //             });
        //     });
        // }
    
    </script>
</body>
</html>
