<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitAI - ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢&é‹å‹•ã‚³ãƒ¼ãƒãƒ³ã‚°AI</title>
    
    <!-- ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    
    <!-- PWAè¨­å®š -->
    <!-- <meta name="apple-mobile-web-app-capable" content="yes"> -->
    <!-- <meta name="apple-mobile-web-app-status-bar-style" content="default"> -->
    <!-- <meta name="apple-mobile-web-app-title" content="FitAI"> -->
    <!-- <meta name="theme-color" content="#0066cc"> -->
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Date picker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 25%, #ff1744 75%, #e91e63 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.05) 50%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            backdrop-filter: blur(20px);
            box-shadow: 0 12px 40px rgba(255, 107, 53, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #ff6b35, #f7931e, #ff1744, transparent);
            animation: energyPulse 2s infinite;
        }

        @keyframes energyPulse {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .logo {
            width: 300px;
            max-width: 100%;
            height: auto;
            margin-bottom: 15px;
        }

        .header h1 {
            background: linear-gradient(135deg, #ff6b35, #ff1744);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 3em;
            margin-bottom: 15px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(255, 107, 53, 0.1);
        }

        .header p {
            color: #555;
            font-size: 1.1em;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
            font-weight: 500;
        }

        .nav-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 25px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 10;
        }

        .nav-tabs {
        display: flex !important;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: center;
        overflow-x: auto;
        padding: 5px;
        }

        .nav-tab {
            flex: 0 0 auto !important;
            min-width: 180px;
            padding: 18px 24px;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 15px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 700;
            font-size: 14px;
            text-align: center;
            text-decoration: none;
            display: flex !important;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 107, 53, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab:hover {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(255, 23, 68, 0.1));
            color: #ff6b35;
            border-color: rgba(255, 107, 53, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.2);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #ff6b35, #ff1744);
            color: white;
            border-color: #ff6b35;
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.4);
            transform: translateY(-2px);
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 500px;
        }

        .page {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 1.8em;
            color: #a855f7;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input:not([type="checkbox"]):not([type="radio"]),
        .form-group select,
        .form-group textarea {
          width: 100%;
          padding: 12px 16px;
          border: 2px solid #e1e5e9;
          border-radius: 10px;
          font-size: 16px;
          transition: all 0.3s ease;
          background: white;
        }

        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.15);
            transform: translateY(-1px);
        }

        .btn {
            background: linear-gradient(135deg, #ff6b35, #ff1744);
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 160px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(255, 107, 53, 0.4);
            background: linear-gradient(135deg, #ff8a65, #ff1744);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20963d);
        }

        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .tabs-container {
            margin-bottom: 30px;
        }


        .upload-area {
            border: 3px dashed #ff6b35;
            border-radius: 20px;
            padding: 50px 30px;
            text-align: center;
            margin: 25px 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.03), rgba(255, 23, 68, 0.02));
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 107, 53, 0.05), transparent);
            animation: rotate 3s linear infinite;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .upload-area:hover::before {
            opacity: 1;
        }

        .upload-area:hover {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.08), rgba(255, 23, 68, 0.05));
            border-color: #ff8a65;
            transform: scale(1.02);
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.2);
        }

        .upload-area.drag-over {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.15), rgba(255, 23, 68, 0.1));
            border-color: #ff1744;
            transform: scale(1.05);
            box-shadow: 0 12px 40px rgba(255, 107, 53, 0.3);
        }

        .file-input {
            display: none;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status-success {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid rgba(40, 167, 69, 0.3);
            color: #155724;
        }

        .status-error {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid rgba(220, 53, 69, 0.3);
            color: #721c24;
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid rgba(255, 193, 7, 0.3);
            color: #856404;
        }

        /* æ—¢å¾€æ­´ã®å¤šé …ç›®é¸æŠ */
        .multiselect-dropdown {
            position: relative;
        }

        .multiselect-selected {
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 10px;
            background: white;
            cursor: pointer;
        }

        .multiselect-options {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            width: 100%;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            z-index: 1000;
            display: none;
        }

        .multiselect-option {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin: 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #f8f9fa;
            border: 1px solid transparent;
        }

        .multiselect-option:hover {
            background: rgba(255, 107, 53, 0.1);
            border-color: rgba(255, 107, 53, 0.3);
        }

        .multiselect-option input {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .multiselect-option label {
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin: 0;
        }

        .multiselect-option.selected {
            background: rgba(255, 107, 53, 0.1);
            border-color: #ff6b35;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-canvas {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: white;
            border-radius: 18px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 6px 25px rgba(255, 107, 53, 0.1);
            border: 2px solid rgba(255, 107, 53, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b35, #f7931e, #ff1744);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .metric-card:hover::before {
            transform: scaleX(1);
        }

        .metric-card:hover {
            border-color: #ff6b35;
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(255, 107, 53, 0.2);
        }

        .metric-value {
            font-size: 2.2em;
            font-weight: 900;
            background: linear-gradient(135deg, #ff6b35, #ff1744);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .metric-label {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .coaching-result {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.05), rgba(255, 23, 68, 0.03));
            border-radius: 20px;
            padding: 30px;
            margin: 25px 0;
            border-left: 6px solid #ff6b35;
            line-height: 1.8;
            border: 1px solid rgba(255, 107, 53, 0.2);
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.1);
        }

        .coaching-result h3 {
            background: linear-gradient(135deg, #ff6b35, #ff1744);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            font-weight: 800;
        }

        .date-range-container {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .period-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 8px 16px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .period-btn.active {
            border-color: #a855f7;
            background: linear-gradient(135deg, #a855f7, #3b82f6);
            color: white;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .error-message {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 5px;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 8px;
            }
            
            .nav-tab {
                min-width: auto;
                width: 100%;
                margin-bottom: 0;
            }
            
            .content {
                padding: 20px 15px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .date-range-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .period-buttons {
                justify-content: center;
            }

            .multiselect-container {
                grid-template-columns: 1fr;
            }
        }

        /* PWAç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .pwa-install-banner {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b35, #ff1744);
            color: white;
            padding: 18px;
            border-radius: 15px;
            display: none;
            z-index: 1000;
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .pwa-install-banner.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .meal-table-container {
            margin-top: 20px;
            overflow-x: auto;
        }

        #meals-table {
            width: 100%;
            border-collapse: collapse;
        }
        #meals-table th, #meals-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        #meals-table th {
            background-color: #f9f9f9;
        }

        .coach-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }

        .coach-option {
            width: 180px;
            border: 2px dashed #ccc;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 10px;
            background: #fff;
            text-align: center;
        }

        .coach-option img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .coach-name {
            font-weight: 700;
            margin-bottom: 5px;
        }

        .coach-intro {
            font-size: 0.85em;
            color: #555;
        }

        .coach-option.selected {
            border-color: #ff6b35;
            background: rgba(255,107,53,0.1);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 15px;">
                <div style="font-size: 4em; filter: drop-shadow(0 4px 8px rgba(255, 107, 53, 0.3));">ğŸ’ª</div>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                    <img src="/static/logo.png" alt="FitAI Logo" style="height: 100px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <h1 style="display: none;">FitAI</h1>
                </div>
                <div style="font-size: 4em; filter: drop-shadow(0 4px 8px rgba(255, 107, 53, 0.3));">ğŸ”¥</div>
            </div>
            <p>FitAIã¯ã€ã‚ãªãŸã®ä½“ã®ãƒ‡ãƒ¼ã‚¿ãƒ»ç”Ÿæ´»ç¿’æ…£ãƒ»ç›®æ¨™ã«åˆã‚ã›ã¦ã€ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ã„ãŸæœ€é©ãªè¡Œå‹•ãƒ—ãƒ©ãƒ³ã‚’ææ¡ˆã™ã‚‹ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ˜ãƒ«ã‚¹ã‚³ãƒ¼ãƒAIã§ã™ã€‚ğŸ’ª ä»Šã™ããƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã‚¸ãƒ£ãƒ¼ãƒ‹ãƒ¼ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼ ğŸš€</p>
        </div>

        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="nav-container">
            <div class="nav-tabs">
                <button class="nav-tab active" data-page="profile">ğŸ’ª ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å…¥åŠ›</button>
                <button class="nav-tab" data-page="meal">ğŸš é£Ÿäº‹ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                <button class="nav-tab" data-page="coaching">ğŸ‹ï¸ AIã‚³ãƒ¼ãƒãƒ³ã‚°</button>
                <button class="nav-tab" data-page="dashboard">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="content">
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å…¥åŠ›ãƒšãƒ¼ã‚¸ -->
            <div id="profile" class="page active">
                <div class="section-title">
                    ğŸ’ª ã‚ãªãŸã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ—ãƒ©ãƒ³ã‚’ä½œã‚Šã¾ã—ã‚‡ã†
                </div>
                <p style="margin-bottom: 30px; color: #666; font-weight: 500;">å…¥åŠ›å¾Œã€Œä¿å­˜ã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ ğŸš€<br>â€»åˆå›å…¥åŠ›ã ã‘ã§OKã€‚å†…å®¹ã‚’å¤‰æ›´ã—ãŸã„ã¨ãã ã‘æ›´æ–°ã—ã¦ãã ã•ã„ã€‚</p>
                
                <form id="profile-form">
                    <div class="form-grid">
                        <div>
                            <div class="form-group">
                                <label>å¹´é½¢</label>
                                <input type="number" id="age" min="0" max="120" placeholder="å¹´é½¢ã‚’å…¥åŠ›">
                            </div>
                            <div class="form-group">
                                <label>æ€§åˆ¥</label>
                                <select id="sex">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="male">ç”·æ€§</option>
                                    <option value="female">å¥³æ€§</option>
                                    <option value="other">ãã®ä»–</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>èº«é•· (cm)</label>
                                <input type="number" id="height_cm" step="0.1" placeholder="èº«é•·ã‚’å…¥åŠ›">
                            </div>
                            <div class="form-group">
                                <label>ç¾ä½“é‡ (kg)</label>
                                <input type="number" id="weight_kg" step="0.1" placeholder="ç¾åœ¨ã®ä½“é‡ã‚’å…¥åŠ›">
                            </div>
                            <div class="form-group">
                                <label>ç›®æ¨™ä½“é‡ (kg)</label>
                                <input type="number" id="target_weight_kg" step="0.1" placeholder="ç›®æ¨™ä½“é‡ã‚’å…¥åŠ›">
                            </div>
                        </div>
                        
                        <div>
                            <div class="form-group">
                                <label>é‹å‹•ç›®çš„ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰</label>
                                <textarea id="goal" rows="3" placeholder="ä¾‹ï¼‰æ¸›é‡ã¨ä½“åŠ›å‘ä¸Šã€‚é€±3å›ã®æœ‰é…¸ç´ ï¼‹è»½ã„ç­‹ãƒˆãƒ¬"></textarea>
                            </div>
                            <div class="form-group">
                                <label>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±</label>
                                <input type="text" id="allergies" placeholder="ä¾‹ï¼‰ãã°ã€ãƒ”ãƒ¼ãƒŠãƒƒãƒ„">
                            </div>
                            <div class="form-group">
                                <label>å–«ç…™é »åº¦ï¼ˆé€±ã‚ãŸã‚Šï¼‰</label>
                                <select id="smoking_status">
                                    <option value="never">ãªã—</option>
                                    <option value="former">ä»¥å‰ã¯å¸ã£ã¦ã„ãŸ</option>
                                    <option value="current">ç¾åœ¨å¸ã£ã¦ã„ã‚‹</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>é£²é…’é »åº¦ï¼ˆé€±ã‚ãŸã‚Šï¼‰</label>
                                <select id="alcohol_habit">
                                    <option value="none">ãªã—</option>
                                    <option value="social">1ã€œ3æ—¥</option>
                                    <option value="moderate">4ã€œ6æ—¥</option>
                                    <option value="heavy">æ¯æ—¥</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ—¢å¾€æ­´ï¼ˆè©²å½“ã‚’é¸æŠâ€»è¤‡æ•°é¸æŠå¯ï¼‰</label>
                        <div class="multiselect-dropdown">
                            <div class="multiselect-selected" id="past-history-selected">é¸æŠã—ã¦ãã ã•ã„</div>
                            <div class="multiselect-options" id="past-history-options">
                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ç¾åœ¨ã®æœè–¬å†…å®¹</label>
                        <textarea id="medications" rows="3" placeholder="ä¾‹ï¼‰é™åœ§è–¬ï¼ˆã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³5mgï¼‰æœ1éŒ  ãªã©"></textarea>
                    </div>

                    <button type="submit" class="btn btn-success" style="width: 100%; font-size: 1.1em; padding: 20px;">
                        ğŸ’¾ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜
                    </button>
                </form>

                <div id="profile-status"></div>
            </div>

            <!-- é£Ÿäº‹ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ -->
            <div id="meal" class="page">
                <div class="section-title">
                    ğŸš æ¯æ—¥ãŠé£Ÿäº‹ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ã—ã¦ã€å¥åº·è¨˜éŒ²ã‚’ç¶šã‘ã¾ã—ã‚‡ã†
                </div>
                <p style="margin-bottom: 30px; color: #666; font-weight: 500;">ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã€Œç™»éŒ²ã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ ğŸ“¸âœ¨</p>

                <div class="tabs-container">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>æ—¥ä»˜</label>
                            <input type="date" id="meal-date">
                        </div>
                        <div class="form-group">
                            <label>æ™‚åˆ»</label>
                            <input type="time" id="meal-time">
                        </div>
                    </div>

                    <div class="upload-area" id="upload-area">
                        <div style="font-size: 4em; margin-bottom: 20px; filter: drop-shadow(0 4px 8px rgba(255, 107, 53, 0.3));">ğŸ“¸</div>
                        <h3 style="font-weight: 800; font-size: 1.3em; margin-bottom: 15px;">ç”»åƒã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</h3>
                        <p style="font-weight: 600; margin-bottom: 20px;">ã¾ãŸã¯</p>
                        <button type="button" class="btn" style="margin-top: 15px;" onclick="document.getElementById('file-input').click()">
                            ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                        </button>
                        <input type="file" id="file-input" class="file-input" accept="image/*">
                    </div>

                    <div id="preview-container" style="display: none;">
                        <img id="preview-image" class="preview-image" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                    </div>

                    <div class="form-group">
                        <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                        <input type="text" id="meal-memo" placeholder="ä¾‹ï¼‰ã”é£¯å¤§ç››ã‚Š ãªã©">
                    </div>

                    <button type="button" class="btn btn-success" id="upload-btn" disabled style="width: 100%; font-size: 1.1em; padding: 20px;">
                        ğŸš€ é£Ÿäº‹ã‚’ç™»éŒ²ã™ã‚‹
                    </button>
                </div>

                <div id="meal-status"></div>
            </div>

            <!-- AIã‚³ãƒ¼ãƒãƒ³ã‚°ãƒšãƒ¼ã‚¸ -->
            <div id="coaching" class="page">
                <div class="section-title">
                    ğŸ˜ƒ ã‚³ãƒ¼ãƒé¸æŠ
                </div>
                <div class="coach-grid">
                    <div class="coach-option" data-character="A">
                        <img src="/static/coach_A.png" alt="æœæ—¥ å¤ªé™½">
                        <div class="coach-name">æœæ—¥ å¤ªé™½</div>
                        <div class="coach-intro">å›ã®åŠªåŠ›ã¯å…¨éƒ¨ã‚ªãƒ¬ãŒè¦‹é€ƒã•ãªã„ãï¼ã©ã‚“ãªå°ã•ãªä¸€æ­©ã ã£ã¦æœ€é«˜ã®æˆé•·ã ã€‚ã•ã‚ã€ä¸€ç·’ã«ã‚‚ã£ã¨å¼·ããªã‚ã†ãœï¼</div>
                    </div>
                    <div class="coach-option" data-character="B">
                        <img src="/static/coach_B.png" alt="é»’å´ åˆƒ">
                        <div class="coach-name">é»’å´ åˆƒ</div>
                        <div class="coach-intro">ç”˜ãˆã¯è¨±ã•ãªã„ã€‚è¨€ã„è¨³ãªã‚“ã¦ç„¡é§„ã ã€‚ã ãŒâ€¦æœ¬æ°—ã§å¤‰ã‚ã‚‹è¦šæ‚ŸãŒã‚ã‚‹ãªã‚‰ã€ã‚ªãƒ¬ãŒé›ãˆã¦ã‚„ã‚‹ã€‚</div>
                    </div>
                    <div class="coach-option" data-character="C">
                        <img src="/static/coach_C.png" alt="æ¡œäº• ç¾å„ª">
                        <div class="coach-name">æ¡œäº• ç¾å„ª</div>
                        <div class="coach-intro">ã‚ãªãŸã®é ‘å¼µã‚Šã‚’ãã£ã¨è¦‹å®ˆã£ã¦ã€ä¸€ç·’ã«å–œã‚“ã§ã„ããŸã„ãªã€‚ç„¡ç†ã—ã™ããšã€ã§ã‚‚å°‘ã—ãšã¤å‰ã«é€²ã‚‚ã†ã­ã€‚</div>
                    </div>
                    <div class="coach-option" data-character="D">
                        <img src="/static/coach_D.png" alt="ç¥å´ ç‡">
                        <div class="coach-name">ç¥å´ ç‡</div>
                        <div class="coach-intro">ã»ã‚“ã£ã¨æƒ…ã‘ãªã„ã‚“ã ã‹ã‚‰â€¦ã§ã‚‚ã€å°‘ã—ã¯æœŸå¾…ã—ã¦ã‚‹ã‚“ã ã‹ã‚‰ã­ã€‚ã¡ã‚ƒã‚“ã¨çµæœã§è¦‹ã›ãªã•ã„ã‚ˆï¼</div>
                    </div>
                </div>

                
                <div class="section-title" style="margin-top: 40px;>
                    ğŸ‹ï¸ AIã‚³ãƒ¼ãƒã‹ã‚‰ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å—ã‘ã¾ã—ã‚‡ã†
                </div>
                <p style="margin-bottom: 30px; color: #666; font-weight: 500;">ç›´è¿‘7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚‚ã¨ã«ã€AIã‚³ãƒ¼ãƒãŒã‚ãªãŸå°‚ç”¨ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚ğŸ’ªğŸ”¥</p>

                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="show-prompt">
                        <span>é€ä¿¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º</span>
                    </label>
                </div>

                <button type="button" class="btn btn-success" id="coaching-btn" style="width: 100%; font-size: 1.2em; padding: 25px;">
                    ğŸ¯ ã‚³ãƒ¼ãƒãƒ³ã‚°ã‚’å®Ÿè¡Œã™ã‚‹
                </button>

                <div id="coaching-status"></div>
                <div id="coaching-result"></div>
                <div id="coaching-prompt" style="display: none;"></div>
            </div>

            <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ -->
            <div id="dashboard" class="page">
                <div class="section-title">
                    ğŸ“Š è¨ˆæ¸¬çµæœã®æ¨ç§»
                </div>

                <div class="date-range-container">
                    <div>
                        <label style="font-weight: 700; color: #ff6b35;">æœŸé–“ã‚’é¸æŠ</label>
                        <input type="date" id="start-date">
                    </div>
                    <div>
                        <label style="font-weight: 700; color: #ff6b35;">ã€œ</label>
                        <input type="date" id="end-date">
                    </div>
                    <button class="btn" id="update-dashboard">
                        ğŸ”„ æ›´æ–°
                    </button>
                </div>

                <div class="period-buttons">
                    <button class="period-btn active" data-days="7">éå»7æ—¥</button>
                    <button class="period-btn" data-days="14">éå»14æ—¥</button>
                    <button class="period-btn" data-days="30">éå»30æ—¥</button>
                    <button class="period-btn" data-days="90">éå»90æ—¥</button>
                </div>

                <div class="dashboard-grid">
                    <div class="chart-container">
                        <div class="chart-title">
                            ğŸ”¥ ã‚«ãƒ­ãƒªãƒ¼åæ”¯ï¼ˆæ¶ˆè²»ãƒ»æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼ï¼‰
                        </div>
                        <div class="chart-canvas">
                            <canvas id="calorie-chart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">
                            ğŸ“ˆ ä½“é‡å¤‰åŒ–
                        </div>
                        <div class="chart-canvas">
                            <canvas id="weight-change-chart"></canvas>
                        </div>
                        <div id="weight-change-summary" class="metric-card" style="margin-top: 15px;">
                            <div class="metric-value" id="total-weight-change">--</div>
                            <div class="metric-label">æœŸé–“ä¸­ã®ä½“é‡å¤‰åŒ– (ç†è«–å€¤)</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">
                            âš–ï¸ ä½“é‡æ¨ç§»
                        </div>
                        <div class="chart-canvas">
                            <canvas id="weight-chart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">
                            ğŸ“‰ ä½“è„‚è‚ªç‡æ¨ç§»
                        </div>
                        <div class="chart-canvas">
                            <canvas id="body-fat-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="meal-table-container">
                    <h3>ğŸ½ï¸ é£Ÿäº‹ä¸€è¦§</h3>
                    <table id="meals-table">
                        <thead><tr></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="dashboard-status"></div>
            </div>
        </div>

        <!-- PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ -->
        <div id="pwa-install-banner" class="pwa-install-banner">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>ğŸ“± ã‚¢ãƒ—ãƒªã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</strong>
                    <div style="font-size: 14px; opacity: 0.9;">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚ˆã‚Šä¾¿åˆ©ã«ä½¿ãˆã¾ã™</div>
                </div>
                <div>
                    <button class="btn" id="pwa-install-btn" style="margin-right: 10px;">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('pwa-install-banner').classList.remove('show')">å¾Œã§</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†
        class FitAIApp {
            constructor() {
                this.currentPage = 'profile';
                this.apiBaseUrl = '';
                this.apiToken = localStorage.getItem('fitai_api_token') || '';
                this.charts = {};
                this.selectedFile = null;
                this.isUploading = false;
                this.selectedCoach = localStorage.getItem('fitai_coach') || 'A';
                // PASTEã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãæ—¢å¾€æ­´ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                this.pastHistoryOptions = [
                    {value: 'hypertension', label: 'é«˜è¡€åœ§'},
                    {value: 'diabetes', label: 'ç³–å°¿ç—…'},
                    {value: 'cad', label: 'å¿ƒç–¾æ‚£'},
                    {value: 'stroke', label: 'è„³å’ä¸­ï¼ˆè„³æ¢—å¡ãƒ»è„³å‡ºè¡€ï¼‰'},
                    {value: 'asthma', label: 'æ°—ç®¡æ”¯å–˜æ¯'},
                    {value: 'copd', label: 'æ…¢æ€§é–‰å¡æ€§è‚ºç–¾æ‚£ï¼ˆCOPDï¼‰'},
                    {value: 'ulcer', label: 'èƒƒæ½°ç˜ãƒ»åäºŒæŒ‡è…¸æ½°ç˜'},
                    {value: 'hepatitis', label: 'è‚ç‚ï¼ˆBå‹ãƒ»Cå‹ï¼‰'},
                    {value: 'kidney', label: 'æ…¢æ€§è…ä¸å…¨'},
                    {value: 'cancer', label: 'æ‚ªæ€§è…«ç˜ï¼ˆãŒã‚“ï¼‰'},
                    {value: 'osteoporosis', label: 'éª¨ç²—é¬†ç—‡'},
                    {value: 'ra', label: 'é–¢ç¯€ãƒªã‚¦ãƒãƒ'},
                    {value: 'depression', label: 'ã†ã¤ç—…'},
                    {value: 'epilepsy', label: 'ã¦ã‚“ã‹ã‚“'},
                    {value: 'drug_allergy', label: 'è–¬å‰¤ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼'},
                    {value: 'other', label: 'ãã®ä»–'}
                ];
                this.initializeApp();
            }


            // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
            initializeApp() {
                this.setupEventListeners();
                this.setupPWA();
                this.setupPastHistoryMultiselect();
                this.loadProfile();
                this.setupMealUpload();
                this.restoreState();
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ—¥ä»˜è¨­å®š
                const today = new Date();
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(today.getDate() - 6);

                document.getElementById('start-date').value = this.formatDate(sevenDaysAgo);
                document.getElementById('end-date').value = this.formatDate(today);
                this.setDefaultMealDateTime();
                this.selectCoach(this.selectedCoach);
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            setupEventListeners() {
                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const page = e.currentTarget.dataset.page;
                        this.navigateToPage(page);
                    });
                });

                // ã‚³ãƒ¼ãƒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ
                document.querySelectorAll('.coach-option').forEach(opt => {
                    opt.addEventListener('click', (e) => {
                        this.selectCoach(e.currentTarget.dataset.character);
                    });
                });

                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ•ã‚©ãƒ¼ãƒ 
                document.getElementById('profile-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveProfile();
                });

                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                document.getElementById('upload-btn').addEventListener('click', () => {
                    this.uploadMeal();
                });

                // ã‚³ãƒ¼ãƒãƒ³ã‚°å®Ÿè¡Œ
                document.getElementById('coaching-btn').addEventListener('click', () => {
                    this.runCoaching();
                });

                // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
                document.getElementById('update-dashboard').addEventListener('click', () => {
                    this.updateDashboard();
                });

                // æœŸé–“ãƒœã‚¿ãƒ³
                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.setPeriod(parseInt(e.target.dataset.days));
                    });
                });

                // ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹/é€²ã‚€ãƒœã‚¿ãƒ³
                window.addEventListener('popstate', (event) => {
                    if (event.state && event.state.page) {
                        this.currentPage = event.state.page;
                        this.showPage(this.currentPage);
                    }
                });
            }

            // PWAè¨­å®š
            setupPWA() {
                let deferredPrompt;

                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    document.getElementById('pwa-install-banner').classList.add('show');
                });

                document.getElementById('pwa-install-btn').addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            document.getElementById('pwa-install-banner').classList.remove('show');
                        }
                        deferredPrompt = null;
                    }
                });

                // ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ç™»éŒ²ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('/sw.js')
                            .then((registration) => {
                                console.log('SW registered: ', registration);
                            })
                            .catch((registrationError) => {
                                console.log('SW registration failed: ', registrationError);
                            });
                    });
                }
            }

            // æ—¢å¾€æ­´ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆè¨­å®š
            setupPastHistoryMultiselect() {
                const optionsContainer = document.getElementById('past-history-options');
                const selectedDisplay = document.getElementById('past-history-selected');
                optionsContainer.innerHTML = '';

                this.pastHistoryOptions.forEach(option => {
                    const div = document.createElement('div');
                    div.className = 'multiselect-option';
                    div.innerHTML = `
                        <input type="checkbox" id="past-${option.value}" value="${option.value}">
                        <label for="past-${option.value}">${option.label}</label>
                    `;

                    const checkbox = div.querySelector('input');
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            div.classList.add('selected');
                        } else {
                            div.classList.remove('selected');
                        }
                        this.updatePastHistorySelected();
                    });

                    div.addEventListener('click', (e) => {
                      if (e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL') return;
                      checkbox.checked = !checkbox.checked;
                      checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                    });

                    optionsContainer.appendChild(div);
                });

                selectedDisplay.addEventListener('click', () => {
                    optionsContainer.style.display = optionsContainer.style.display === 'block' ? 'none' : 'block';
                });

                document.addEventListener('click', (e) => {
                    if (!optionsContainer.contains(e.target) && !selectedDisplay.contains(e.target)) {
                        optionsContainer.style.display = 'none';
                    }
                });

                this.updatePastHistorySelected();
            }

            updatePastHistorySelected() {
                const selectedDisplay = document.getElementById('past-history-selected');
                if (!selectedDisplay) return;
                const selectedLabels = [];
                this.pastHistoryOptions.forEach(option => {
                    const checkbox = document.getElementById(`past-${option.value}`);
                    if (checkbox && checkbox.checked) {
                        selectedLabels.push(option.label);
                    }
                });
                selectedDisplay.textContent = selectedLabels.length ? selectedLabels.join('ã€') : 'é¸æŠã—ã¦ãã ã•ã„';
            }

            // é£Ÿäº‹ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®š
            setupMealUpload() {
                const uploadArea = document.getElementById('upload-area');
                const fileInput = document.getElementById('file-input');
                const previewContainer = document.getElementById('preview-container');
                const previewImage = document.getElementById('preview-image');
                const uploadBtn = document.getElementById('upload-btn');

                // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('drag-over');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('drag-over');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFileSelect(files[0]);
                    }
                });

                // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFileSelect(e.target.files[0]);
                    }
                });
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
            handleFileSelect(file) {
                if (!file.type.startsWith('image/')) {
                    this.showStatus('meal-status', 'ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                    return;
                }

                this.selectedFile = file;
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('preview-image').src = e.target.result;
                    document.getElementById('preview-container').style.display = 'block';
                    document.getElementById('upload-btn').disabled = false;
                };
                reader.readAsDataURL(file);
            }

            // ãƒšãƒ¼ã‚¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
            navigateToPage(pageId) {
                this.currentPage = pageId;
                this.showPage(pageId);
                this.saveState();
                
                // URLã‚’æ›´æ–°
                history.pushState({page: pageId}, '', `#${pageId}`);
                
                // ãƒšãƒ¼ã‚¸å›ºæœ‰ã®å‡¦ç†
                if (pageId === 'dashboard') {
                    if (Object.keys(this.charts).length === 0) {
                        this.initializeDashboard();
                    }
                    setTimeout(() => {
                        Object.values(this.charts).forEach(chart => chart.resize());
                        this.updateDashboard();
                    }, 100);
                }
            }

            // ãƒšãƒ¼ã‚¸è¡¨ç¤º
            showPage(pageId) {
                // å…¨ãƒšãƒ¼ã‚¸ã‚’éè¡¨ç¤º
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                
                // å…¨ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // æŒ‡å®šãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const targetPage = document.getElementById(pageId);
                const targetTab = document.querySelector(`[data-page="${pageId}"]`);
                
                if (targetPage) {
                    targetPage.classList.add('active');
                }
                
                if (targetTab) {
                    targetTab.classList.add('active');
                }

                // é£Ÿäº‹ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«ç¾åœ¨æ—¥æ™‚ã‚’è¨­å®š
                if (pageId === 'meal') {
                    this.setDefaultMealDateTime();
                }
            }

            // APIå‘¼ã³å‡ºã—ãƒ˜ãƒ«ãƒ‘ãƒ¼
            async apiCall(endpoint, options = {}) {
                const headers = {
                    ...options.headers
                };

                // JSONé€ä¿¡ã§ãªã„å ´åˆï¼ˆFormDataãªã©ï¼‰ã¯Content-Typeã‚’è¨­å®šã—ãªã„
                if (!(options.body instanceof FormData)) {
                    headers['Content-Type'] = 'application/json';
                }

                if (this.apiToken) {
                    headers['x-api-token'] = this.apiToken;
                }

                // APIã‚³ãƒ¼ãƒ«ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼ˆ500msï¼‰
                const now = Date.now();
                if (this._lastApiCallTime && now - this._lastApiCallTime < 500) {
                    await new Promise(resolve => setTimeout(resolve, 500 - (now - this._lastApiCallTime)));
                }
                this._lastApiCallTime = Date.now();

                try {
                    const response = await fetch(`${this.apiBaseUrl}${endpoint}`, {
                        ...options,
                        headers
                    });
                    
                    if (!response.ok) {
                        // 401ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒˆãƒ¼ã‚¯ãƒ³ãªã—ã§å†è©¦è¡Œ
                        if (response.status === 401 && this.apiToken) {
                            console.log('401 error detected, retrying without token...');
                            const headersWithoutToken = { ...headers };
                            delete headersWithoutToken['x-api-token'];
                            
                            const retryResponse = await fetch(`${this.apiBaseUrl}${endpoint}`, {
                                ...options,
                                headers: headersWithoutToken
                            });
                            
                            if (retryResponse.ok) {
                                return await retryResponse.json();
                            }
                        }
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error(`API call failed for ${endpoint}:`, error);
                    throw error;
                }
            }

            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
            async loadProfile() {
                try {
                    const response = await this.apiCall('/ui/profile');
                    const profile = response.profile || {};
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
                    Object.keys(profile).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && profile[key] !== null && profile[key] !== undefined) {
                            if (element.type === 'checkbox') {
                                element.checked = profile[key];
                            } else {
                                element.value = profile[key];
                            }
                        }
                    });

                    // æ—¢å¾€æ­´ã®è¨­å®š
                    if (profile.past_history && Array.isArray(profile.past_history)) {
                        const jp2eng = {
                            "é«˜è¡€åœ§": "hypertension",
                            "ç³–å°¿ç—…": "diabetes",
                            "å¿ƒç–¾æ‚£": "cad",
                            "è„³å’ä¸­ï¼ˆè„³æ¢—å¡ãƒ»è„³å‡ºè¡€ï¼‰": "stroke",
                            "æ°—ç®¡æ”¯å–˜æ¯": "asthma",
                            "æ…¢æ€§é–‰å¡æ€§è‚ºç–¾æ‚£ï¼ˆCOPDï¼‰": "copd",
                            "èƒƒæ½°ç˜ãƒ»åäºŒæŒ‡è…¸æ½°ç˜": "ulcer",
                            "è‚ç‚ï¼ˆBå‹ãƒ»Cå‹ï¼‰": "hepatitis",
                            "æ…¢æ€§è…ä¸å…¨": "kidney",
                            "æ‚ªæ€§è…«ç˜ï¼ˆãŒã‚“ï¼‰": "cancer",
                            "éª¨ç²—é¬†ç—‡": "osteoporosis",
                            "é–¢ç¯€ãƒªã‚¦ãƒãƒ": "ra",
                            "ã†ã¤ç—…": "depression",
                            "ã¦ã‚“ã‹ã‚“": "epilepsy",
                            "è–¬å‰¤ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼": "drug_allergy",
                            "ãã®ä»–": "other"
                        };
                        profile.past_history.forEach(item => {
                            const value = jp2eng[item] || item;
                            const checkbox = document.getElementById(`past-${value}`);
                            if (checkbox) {
                                checkbox.checked = true;
                                checkbox.closest('.multiselect-option').classList.add('selected');
                            }
                        });
                        this.updatePastHistorySelected();
                    }

                } catch (error) {
                    console.error('Failed to load profile:', error);
                }
            }

            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜
            async saveProfile() {
                const saveBtn = document.querySelector('#profile-form button[type="submit"]');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<span class="loading-spinner"></span> ä¿å­˜ä¸­...';
                }
                try {
                    const formData = new FormData(document.getElementById('profile-form'));
                    
                    // æ—¢å¾€æ­´ã®åé›†
                    const pastHistory = [];
                    this.pastHistoryOptions.forEach(option => {
                        const checkbox = document.getElementById(`past-${option.value}`);
                        if (checkbox && checkbox.checked) {
                            pastHistory.push(option.value);
                        }
                    });

                    const profileData = {
                        age: parseInt(document.getElementById('age').value) || null,
                        sex: document.getElementById('sex').value || null,
                        height_cm: parseFloat(document.getElementById('height_cm').value) || null,
                        weight_kg: parseFloat(document.getElementById('weight_kg').value) || null,
                        target_weight_kg: parseFloat(document.getElementById('target_weight_kg').value) || null,
                        goal: document.getElementById('goal').value || null,
                        allergies: document.getElementById('allergies').value || null,
                        smoking_status: document.getElementById('smoking_status').value || null,
                        alcohol_habit: document.getElementById('alcohol_habit').value || null,
                        past_history: pastHistory.length > 0 ? pastHistory : null,
                        medications: document.getElementById('medications').value || null
                    };

                    // nullå€¤ã‚’é™¤å»
                    Object.keys(profileData).forEach(key => {
                        if (profileData[key] === null || profileData[key] === '') {
                            delete profileData[key];
                        }
                    });

                    const result = await this.apiCall('/ui/profile', {
                        method: 'POST',
                        body: JSON.stringify(profileData)
                    });

                    if (result.ok) {
                        this.showStatus('profile-status', 'âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                        
                        // BigQueryåŒæœŸçµæœã‚’è¡¨ç¤º
                        if (result.bq && !result.bq.ok) {
                            this.showStatus('profile-status', `âš ï¸ åŒæœŸå¤±æ•—: ${result.bq.reason || result.bq.error}`, 'warning', true);
                        } else if (result.bq && result.bq.ok) {
                            this.showStatus('profile-status', 'âœ… åŒæœŸå®Œäº†', 'success', true);
                        }
                    } else {
                        throw new Error(result.error || 'Unknown error');
                    }

                    this.saveState();

                } catch (error) {
                    this.showStatus('profile-status', `âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
                } finally {
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = 'ğŸ’¾ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜';
                    }
                }
            }

            // é£Ÿäº‹ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            async uploadMeal() {
                if (this.isUploading) {
                    return;
                }
                if (!this.selectedFile) {
                    this.showStatus('meal-status', 'ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                    return;
                }

                this.isUploading = true;
                const uploadBtn = document.getElementById('upload-btn');
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<span class="loading-spinner"></span> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

                try {
                    const mealDate = document.getElementById('meal-date').value;
                    const mealTime = document.getElementById('meal-time').value;
                    const mealMemo = document.getElementById('meal-memo').value;

                    const whenISO = `${mealDate}T${mealTime}:00`;

                    // FormData for file upload
                    const formData = new FormData();
                    formData.append('file', this.selectedFile);
                    formData.append('when', whenISO);
                    formData.append('memo', mealMemo);

                    // ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°ãƒ˜ãƒƒãƒ€ãƒ¼ã«ä»˜ä¸ã—ã¦1å›ã ã‘é€ä¿¡
                    const headers = this.apiToken ? { 'x-api-token': this.apiToken } : {};
                    const response = await fetch(`${this.apiBaseUrl}/ui/meal_image`, {
                        method: 'POST',
                        headers: headers,
                        body: formData
                    });

                    const responseClone = response.clone();

                    if (!response.ok) {
                        const text = await response.text();
                        const error = new Error(`Upload failed: ${response.status}`);
                        error.serverResponse = text;
                        throw error;
                    }

                    let result;
                    try {
                        result = await response.json();
                    } catch (parseError) {
                        const text = await responseClone.text();
                        const error = new Error(`Invalid JSON response: ${parseError.message}`);
                        error.serverResponse = text;
                        throw error;
                    }

                    if (result.ok) {
                        this.showStatus('meal-status', 'âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†', 'success');
                        
                        if (result.preview) {
                            const previewDiv = document.createElement('div');
                            previewDiv.className = 'coaching-result';
                            previewDiv.innerHTML = `<h3>ğŸ“ ç”»åƒè¦ç´„</h3><p>${result.preview}</p>`;
                            document.getElementById('meal-status').appendChild(previewDiv);
                        }

                        // ãƒ¡ãƒ¢ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ ã§é€ä¿¡
                        if (mealMemo.trim()) {
                            try {
                                await this.apiCall('/ui/meal', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        when: whenISO,
                                        text: mealMemo,
                                        kcal: null
                                    })
                                });
                                this.showStatus('meal-status', 'ğŸ’¬ ãƒ¡ãƒ¢ã‚‚ç™»éŒ²ã—ã¾ã—ãŸ', 'success', true);
                            } catch (error) {
                                this.showStatus('meal-status', 'âš ï¸ ãƒ¡ãƒ¢ä¿å­˜ã«å¤±æ•—ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰', 'warning', true);
                            }
                        }

                        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                        this.resetMealForm();
                    } else {
                        const error = new Error(result.error || 'Unknown error');
                        error.serverResponse = JSON.stringify(result);
                        throw error;
                    }

                } catch (error) {
                    const details = error.serverResponse ? `\nã‚µãƒ¼ãƒãƒ¼è©³ç´°: ${error.serverResponse}` : '';
                    this.showStatus('meal-status', `âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}${details}`, 'error');
                } finally {
                    this.isUploading = false;
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = 'ğŸš€ é£Ÿäº‹ã‚’ç™»éŒ²ã™ã‚‹';
                }
            }

            // æ—¥ä»˜ãƒ»æ™‚åˆ»ã®åˆæœŸå€¤ã‚’æ—¥æœ¬æ™‚é–“ã§è¨­å®š
            setDefaultMealDateTime() {
                const now = new Date();
                document.getElementById('meal-date').value =
                    now.toLocaleDateString('en-CA', { timeZone: 'Asia/Tokyo' });
                document.getElementById('meal-time').value =
                    now.toLocaleTimeString('en-GB', {
                        timeZone: 'Asia/Tokyo',
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit'
                    });
            }

            // é£Ÿäº‹ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            resetMealForm() {
                this.selectedFile = null;
                document.getElementById('preview-container').style.display = 'none';
                document.getElementById('meal-memo').value = '';
                document.getElementById('file-input').value = '';
                document.getElementById('upload-btn').disabled = true;
                this.setDefaultMealDateTime();
            }

            // ã‚³ãƒ¼ãƒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ
            selectCoach(character) {
                this.selectedCoach = character;
                localStorage.setItem('fitai_coach', character);
                document.querySelectorAll('.coach-option').forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.character === character);
                });
            }

            // AIã‚³ãƒ¼ãƒãƒ³ã‚°å®Ÿè¡Œ
            async runCoaching() {
                const coachingBtn = document.getElementById('coaching-btn');
                const showPrompt = document.getElementById('show-prompt').checked;
                
                coachingBtn.disabled = true;
                coachingBtn.innerHTML = '<span class="loading-spinner"></span> å®Ÿè¡Œä¸­...';

                try {
                    const params = new URLSearchParams();
                    if (showPrompt) params.set('show_prompt', '1');
                    if (this.selectedCoach) params.set('character', this.selectedCoach);
                    const query = params.toString();
                    const response = await this.apiCall(`/coach/weekly${query ? `?${query}` : ''}`);

                    if (response.ok) {
                        this.showStatus('coaching-status', 'âœ… ã‚³ãƒ¼ãƒãƒ³ã‚°ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ', 'success');

                        if (response.preview) {
                            document.getElementById('coaching-result').innerHTML = `
                                <div class="coaching-result">
                                    <h3>ğŸ“ ã‚³ãƒ¼ãƒã‹ã‚‰ã®ææ¡ˆ</h3>
                                    <div style="white-space: pre-line;">${response.preview}</div>
                                </div>
                            `;
                        }

                        if (showPrompt && response.prompt) {
                            document.getElementById('coaching-prompt').innerHTML = `
                                <div class="coaching-result">
                                    <h3>ğŸ” é€ä¿¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h3>
                                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px;">${response.prompt}</pre>
                                </div>
                            `;
                            document.getElementById('coaching-prompt').style.display = 'block';
                        }
                    } else {
                        throw new Error(response.error || 'Unknown error');
                    }

                } catch (error) {
                    this.showStatus('coaching-status', `âŒ å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
                } finally {
                    coachingBtn.disabled = false;
                    coachingBtn.innerHTML = 'ğŸ¯ ã‚³ãƒ¼ãƒãƒ³ã‚°ã‚’å®Ÿè¡Œã™ã‚‹';
                }
            }

            // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–
            
// æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆã‚’å®‰å…¨ã«ç ´æ£„ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
safeDestroyChartByCanvasId(id) {
    const el = document.getElementById(id);
    if (!el) return null;
    let existing = null;
    try {
        existing = Chart.getChart ? Chart.getChart(el) : (el._chart || null);
        if (existing && typeof existing.destroy === 'function') {
            existing.destroy();
        }
    } catch (e) {
        console.warn('[dashboard] safeDestroyChartByCanvasId failed', e);
    }
    return existing;
}

initializeDashboard() {
                // Chart.js ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
                Chart.defaults.color = '#666';
                Chart.defaults.borderColor = 'rgba(0, 0, 0, 0.1)';

                // ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
                this.createCalorieChart();
                this.createWeightChangeChart();
                this.createWeightChart();
            }

            // ã‚«ãƒ­ãƒªãƒ¼ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
            createCalorieChart() {
                const ctx = document.getElementById('calorie-chart').getContext('2d');
                this.charts.calorie = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼',
                                data: [],
                                borderColor: '#ff1744',
                                backgroundColor: 'rgba(255, 23, 68, 0.1)',
                                borderWidth: 4,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#ff1744',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 3,
                                pointRadius: 6
                            },
                            {
                                label: 'æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼',
                                data: [],
                                borderColor: '#66bb6a',
                                backgroundColor: 'rgba(102, 187, 106, 0.1)',
                                borderWidth: 4,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#66bb6a',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 3,
                                pointRadius: 6
                            }
                        ]
                    },
                    options: this.getChartOptions('ã‚«ãƒ­ãƒªãƒ¼ (kcal)')
                });
            }

            // ä½“é‡å¤‰åŒ–ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
            createWeightChangeChart() {
                const ctx = document.getElementById('weight-change-chart').getContext('2d');
                this.charts.weightChange = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'ä½“é‡å¤‰åŒ– (kg)',
                            data: [],
                            backgroundColor: (context) => {
                                const value = context.parsed?.y;
                                if (value === undefined) {
                                    // å‡¡ä¾‹æç”»æ™‚ã«ã¯ value ãŒæœªå®šç¾©ã«ãªã‚‹ãŸã‚ã€æ£’ã‚°ãƒ©ãƒ•ã¨æƒãˆãŸèµ¤è‰²ã‚’è¿”ã™
                                    return 'rgba(255, 107, 107, 0.8)';
                                }
                                return value > 0
                                    ? 'rgba(255, 107, 107, 0.8)'
                                    : 'rgba(40, 167, 69, 0.8)';
                            },
                            borderColor: (context) => {
                                const value = context.parsed?.y;
                                if (value === undefined) {
                                    // å‡¡ä¾‹ç”¨ã«èµ¤è‰²ã‚’è¿”ã™
                                    return '#ff6b6b';
                                }
                                return value > 0 ? '#ff6b6b' : '#28a745';
                            },
                            borderWidth: 2
                        }]
                    },
                    options: this.getChartOptions('ä½“é‡å¤‰åŒ– (kg)')
                });
            }

            // ä½“é‡ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
            createWeightChart() {
                const ctx = document.getElementById('weight-chart').getContext('2d');
                this.charts.weight = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'ä½“é‡ (kg)',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: this.getChartOptions('ä½“é‡ (kg)')
                });
            }

            // ä½“è„‚è‚ªç‡ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
            createBodyFatChart() {
                const ctx = document.getElementById('body-fat-chart').getContext('2d');
                this.charts.bodyFat = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'ä½“è„‚è‚ªç‡ (%)',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: this.getChartOptions('ä½“è„‚è‚ªç‡ (%)')
                });
            }

            // å…±é€šãƒãƒ£ãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³
            getChartOptions(yAxisLabel) {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#666' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#666' },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yAxisLabel,
                                color: '#666'
                            }
                        }
                    }
                };
            }

            // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
            async updateDashboard() {
              const updateBtn = document.getElementById('update-dashboard');
              if (updateBtn) {
                updateBtn.disabled = true;
                updateBtn.innerHTML = '<span class="loading-spinner"></span> æ›´æ–°ä¸­...';
              }
            
              const startDate = document.getElementById('start-date').value;
              const endDate   = document.getElementById('end-date').value;
            
              if (!startDate || !endDate) {
                this.showStatus('dashboard-status', 'æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                if (updateBtn) {
                  updateBtn.disabled = false;
                  updateBtn.innerHTML = 'âŸ³ æ›´æ–°';
                }
                return;
              }
            
              this.showStatus('dashboard-status', 'ğŸ“Š ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...', 'warning');
            
              try {
                const response = await this.apiCall(
                  `/dashboard/summary?start_date=${startDate}&end_date=${endDate}&user_id=demo`
                );
            
                // â˜…è¿½åŠ ï¼šå–å¾—çµæœã®å¯è¦–åŒ–ï¼ˆä¸å…·åˆæ™‚ã®åˆ‡ã‚Šåˆ†ã‘ç”¨ï¼‰
                console.log('[dashboard] summary response', response);
            
                // â˜…ã‚¬ãƒ¼ãƒ‰ï¼ˆæƒ³å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ãªã‘ã‚Œã°ä¸­æ–­ï¼‰
                if (!response || !response.data) {
                  this.showStatus('dashboard-status', 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                  return;
                }
                
                
// â˜…å†æç”»å‰ã«æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆã‚’å®‰å…¨ã«ç ´æ£„ã—ã€å‚ç…§ã‚’ã‚¯ãƒªã‚¢
try {
  const destroyedCalorie = this.safeDestroyChartByCanvasId('calorie-chart');
  const destroyedWeightChange = this.safeDestroyChartByCanvasId('weight-change-chart');
  const destroyedWeight = this.safeDestroyChartByCanvasId('weight-chart');
  const destroyedBodyFat = this.safeDestroyChartByCanvasId('body-fat-chart');
  if (!this.charts) this.charts = {};
  if (destroyedCalorie || this.charts.calorie) this.charts.calorie = null;
  if (destroyedWeightChange || this.charts.weightChange) this.charts.weightChange = null;
  if (destroyedWeight || this.charts.weight) this.charts.weight = null;
  if (destroyedBodyFat || this.charts.bodyFat) this.charts.bodyFat = null;
} catch (e) {
  console.warn('[dashboard] destroy existing charts failed', e);
}

// â˜…ãƒãƒ£ãƒ¼ãƒˆæœªç”Ÿæˆã§ã‚‚è½ã¡ãªã„ã‚ˆã†ä¿é™ºï¼ˆæ—¢ã«ç”Ÿæˆæ¸ˆãªã‚‰ä½•ã‚‚ã—ãªã„ï¼‰
                if (!this.charts) this.charts = {};
                if (!this.charts.calorie && this.createCalorieChart) this.createCalorieChart();
                if (!this.charts.weightChange && this.createWeightChangeChart) this.createWeightChangeChart();
                if (!this.charts.weight && this.createWeightChart) this.createWeightChart();
                if (!this.charts.bodyFat && this.createBodyFatChart) this.createBodyFatChart();
                
                // â˜…updateCharts ã‚’ try-catch ã§å›²ã‚€ï¼ˆæç”»ã‚¨ãƒ©ãƒ¼ã¨é€šä¿¡ã‚¨ãƒ©ãƒ¼ã‚’åˆ†é›¢ï¼‰
                try {
                  this.updateCharts(response.data);
                } catch (e) {
                  console.error('[dashboard] updateCharts failed', e);
                  this.showStatus('dashboard-status', 'æç”»æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                  return;
                }
                
                // æ­£å¸¸æ™‚
                this.showStatus('dashboard-status', 'âœ… æ›´æ–°ã—ã¾ã—ãŸ', 'success');
              } catch (e) {
                console.error('[dashboard] update error', e);
                this.showStatus('dashboard-status', `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e?.message || e}`, 'error');
              } finally {
                // æ—¢å­˜ã®ãƒœã‚¿ãƒ³å¾©å¸°ï¼ˆå¿…ãšå®Ÿè¡Œï¼‰
                if (updateBtn) {
                  updateBtn.disabled = false;
                  updateBtn.innerHTML = 'âŸ³ æ›´æ–°';
                }
              }
            }

            // ãƒ¢ãƒƒã‚¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            generateMockDashboardData(startDate, endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

                const data = {
                    dates: [],
                    consumption_calories: [],
                    take_in_calories: [],
                    weight_change_kg: [],
                    weight_kg: [],
                    fat_percentage: []
                };

                let currentWeight = 70; // åˆæœŸä½“é‡

                for (let i = 0; i < days; i++) {
                    const date = new Date(start);
                    date.setDate(start.getDate() + i);
                    
                    const consumption = Math.floor(Math.random() * 500) + 1800;
                    const intake = Math.floor(Math.random() * 800) + 1500;
                    const weightChange = (intake - consumption) / 7700; // ç°¡æ˜“è¨ˆç®—
                    
                    currentWeight += weightChange + (Math.random() - 0.5) * 0.2; // ãƒã‚¤ã‚ºè¿½åŠ 

                    data.dates.push(date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
                    data.consumption_calories.push(consumption);
                    data.take_in_calories.push(intake);
                    data.weight_change_kg.push(weightChange);
                    data.weight_kg.push(currentWeight);
                    data.fat_percentage.push(20 + (Math.random() - 0.5) * 5);
                }

                return data;
            }

            // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
            updateCharts(data) {
              // --- è¿½åŠ : å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã®ãƒ­ã‚°ï¼ˆåˆ‡ã‚Šåˆ†ã‘ç”¨ï¼‰
              console.log('[updateCharts] input', data);
            
              // --- è¿½åŠ : ãƒãƒ£ãƒ¼ãƒˆã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆæœªç”Ÿæˆãªã‚‰ç”Ÿæˆï¼‰
              if (!this.charts) this.charts = {};
              try {
                if (!this.charts.calorie && this.createCalorieChart) this.createCalorieChart();
                if (!this.charts.weightChange && this.createWeightChangeChart) this.createWeightChangeChart();
                if (!this.charts.weight && this.createWeightChart) this.createWeightChart();
                if (!this.charts.bodyFat && this.createBodyFatChart) this.createBodyFatChart();
              } catch (e) {
                console.error('[updateCharts] chart init error', e);
                throw e; // ã“ã“ã§è½ã¡ãŸã‚‰ try-catch å´ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
              }
            
              // æ—¢å­˜ã®æ¤œè¨¼
              if (!data || !data.dates || !Array.isArray(data.dates)) {
                console.error('Invalid data structure:', data);
                throw new Error('ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
              }
            
              // ä»¥é™ã¯æ—¢å­˜ã®æ›´æ–°å‡¦ç†ã®ã¾ã¾
              this.charts.calorie.data.labels = data.dates;
              this.charts.calorie.data.datasets[0].data = data.take_in_calories || [];
              this.charts.calorie.data.datasets[1].data = data.consumption_calories || [];
              this.charts.calorie.update();
            
              this.charts.weightChange.data.labels = data.dates;
              const weightChangeData = (data.weight_change_kg || []).map(v => v ?? 0);
              this.charts.weightChange.data.datasets[0].data = weightChangeData;
              this.charts.weightChange.update();

              // æœŸé–“ä¸­ã®ä½“é‡å¤‰åŒ–ã‚’åˆè¨ˆã—ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤º
              const totalWeightChange = weightChangeData.reduce((sum, value) => sum + value, 0);
              const summaryEl = document.getElementById('total-weight-change');
              if (summaryEl) {
                const sign = totalWeightChange > 0 ? '+' : '';
                summaryEl.textContent = `${sign}${totalWeightChange.toFixed(2)} kg`;
              }

              this.charts.weight.data.labels = data.dates;
              this.charts.weight.data.datasets[0].data = data.weight_kg || [];
              this.charts.weight.update();

              if (this.charts.bodyFat) {
                this.charts.bodyFat.data.labels = data.dates;
                this.charts.bodyFat.data.datasets[0].data = data.fat_percentage || [];
                this.charts.bodyFat.update();
              }

              if (data.meals_by_date) {
                this.renderMealsTable(data.meals_by_date);
              }

              // æ—¢å­˜ã®ã‚µãƒãƒªãƒ¼æ›´æ–°ã¯ãã®ã¾ã¾
            }

            renderMealsTable(mealsByDate) {
              const table = document.querySelector('#meals-table');
              if (!table) return;
              const tbody = table.querySelector('tbody');
              const theadRow = table.querySelector('thead tr');
              tbody.innerHTML = '';
              theadRow.innerHTML = '';

              const dates = Object.keys(mealsByDate || {}).sort();
              let columns = [];

              for (const date of dates) {
                const meals = mealsByDate[date] || [];
                if (meals.length > 0) {
                  columns = Object.keys(meals[0]).filter(col => col !== 'source');
                  break;
                }
              }

              theadRow.innerHTML = ['<th>æ—¥ä»˜</th>', ...columns.map(c => `<th>${c}</th>`)].join('');

              for (const date of dates) {
                const meals = mealsByDate[date] || [];
                if (meals.length === 0) {
                  const tr = document.createElement('tr');
                  const colspan = Math.max(columns.length, 1);
                  tr.innerHTML = `<td>${date}</td><td colspan="${colspan}">--</td>`;
                  tbody.appendChild(tr);
                  continue;
                }
                for (const meal of meals) {
                  const tr = document.createElement('tr');
                  const cells = columns.map(col => {
                    const val = meal[col] !== undefined && meal[col] !== null ? meal[col] : '';
                    return `<td>${val}</td>`;
                  }).join('');
                  tr.innerHTML = `<td>${date}</td>${cells}`;
                  tbody.appendChild(tr);
                }
              }
            }

            // æœŸé–“è¨­å®š
            setPeriod(days) {
                const end = new Date();
                const start = new Date(end);
                start.setDate(end.getDate() - (days - 1));

                document.getElementById('start-date').value = this.formatDate(start);
                document.getElementById('end-date').value = this.formatDate(end);

                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-days="${days}"]`).classList.add('active');

                this.updateDashboard();
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
            showStatus(containerId, message, type, append = false) {
                const container = document.getElementById(containerId);
                const statusDiv = document.createElement('div');
                statusDiv.className = `status-message status-${type}`;
                statusDiv.textContent = message;

                if (!append) {
                    container.innerHTML = '';
                }
                container.appendChild(statusDiv);

                // è‡ªå‹•å‰Šé™¤ï¼ˆã‚¨ãƒ©ãƒ¼ä»¥å¤–ï¼‰
                if (type !== 'error') {
                    setTimeout(() => {
                        statusDiv.remove();
                    }, 5000);
                }
            }

            // çŠ¶æ…‹ä¿å­˜
            saveState() {
                const state = {
                    currentPage: this.currentPage,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('fitai_app_state', JSON.stringify(state));
            }

            // çŠ¶æ…‹å¾©å…ƒ
            restoreState() {
                const saved = localStorage.getItem('fitai_app_state');
                if (saved) {
                    try {
                        const state = JSON.parse(saved);
                        if (state.currentPage) {
                            this.currentPage = state.currentPage;
                            this.showPage(this.currentPage);
                        }
                    } catch (error) {
                        console.error('Failed to restore state:', error);
                    }
                }
            }

            // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            formatDate(date) {
                return date.toISOString().split('T')[0];
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        let app;

        document.addEventListener('DOMContentLoaded', () => {
            app = new FitAIApp();
        });

        // PWAç”¨ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆç”Ÿæˆ
        const manifest = {
            "name": "FitAI - ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢&é‹å‹•ã‚³ãƒ¼ãƒãƒ³ã‚°AI",
            "short_name": "FitAI",
            "description": "AIã«ã‚ˆã‚‹ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ã¨é‹å‹•ã‚³ãƒ¼ãƒãƒ³ã‚°ã‚¢ãƒ—ãƒª",
            "icons": [
                {
                    "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIHJ4PSI0OCIgZmlsbD0iIzAwNjZjYyIvPjx0ZXh0IHg9Ijk2IiB5PSIxMTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI4MCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPvCfj4PigI3imYI8L3RleHQ+PC9zdmc+",
                    "sizes": "192x192",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                },
                {
                    "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIHJ4PSIxMjgiIGZpbGw9IiMwMDY2Y2MiLz48dGV4dCB4PSIyNTYiIHk9IjMwMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjIwMCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPvCfkqo8L3RleHQ+PC9zdmc+",
                    "sizes": "512x512",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                }
            ],
            "theme_color": "#ff6b35",
            "background_color": "#ffffff",
            "display": "browser",
            "start_url": "/",
            "scope": "/"
        };

        // ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’HTML headã«è¿½åŠ 
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);

        // APIãƒˆãƒ¼ã‚¯ãƒ³è¨­å®šç”¨ã®é–¢æ•°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        function setApiToken(token) {
            localStorage.setItem('fitai_api_token', token);
            if (app) {
                app.apiToken = token;
            }
            console.log('API token set successfully');
        }

        // APIãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤ç”¨ã®é–¢æ•°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        function clearApiToken() {
            localStorage.removeItem('fitai_api_token');
            if (app) {
                app.apiToken = '';
            }
            console.log('API token cleared successfully');
        }

        // APIãƒ™ãƒ¼ã‚¹URLè¨­å®šç”¨ã®é–¢æ•°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        function setApiBaseUrl(url) {
            if (app) {
                app.apiBaseUrl = url;
            }
            console.log('API base URL set to:', url);
        }

        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
        console.log('%cFitAI ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³', 'color: #ff6b35; font-size: 20px; font-weight: bold;');
        console.log('ğŸ”§ ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒãƒ³ãƒ‰:');
        console.log('  clearApiToken() - APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ï¼ˆ401ã‚¨ãƒ©ãƒ¼è§£æ±ºï¼‰');
        console.log('  setApiToken("your-token") - APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š');
        console.log('  setApiBaseUrl("http://localhost:8080") - APIãƒ™ãƒ¼ã‚¹URLã‚’è¨­å®š');
        console.log('  app - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹');

        // // ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ç”¨ã‚³ãƒ¼ãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        // const swCode = `
        //     const CACHE_NAME = 'fitai-v1';
        //     const urlsToCache = [
        //         '/',
        //         '/manifest.json'
        //     ];

        //     self.addEventListener('install', function(event) {
        //         event.waitUntil(
        //             caches.open(CACHE_NAME)
        //                 .then(function(cache) {
        //                     return cache.addAll(urlsToCache);
        //                 })
        //         );
        //     });

        //     self.addEventListener('fetch', function(event) {
        //         event.respondWith(
        //             caches.match(event.request)
        //                 .then(function(response) {
        //                     if (response) {
        //                         return response;
        //                     }
        //                     return fetch(event.request);
        //                 }
        //             )
        //         );
        //     });
        // `;

        // // ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’Blob URLã¨ã—ã¦ä½œæˆ
        // const swBlob = new Blob([swCode], {type: 'application/javascript'});
        // const swURL = URL.createObjectURL(swBlob);

        // // ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ç™»éŒ²
        // if ('serviceWorker' in navigator) {
        //     window.addEventListener('load', () => {
        //         navigator.serviceWorker.register(swURL)
        //             .then((registration) => {
        //                 console.log('ğŸ”§ Service Worker registered successfully');
        //             })
        //             .catch((registrationError) => {
        //                 console.log('âš ï¸ Service Worker registration failed:', registrationError);
        //             });
        //     });
        // }
    
    </script>
</body>
</html>
